# 🔧 トラブルシューティングガイド

## 問題: 実行ボタンを押してもスプレッドシートに変化がない

### 🎯 最も可能性の高い原因と解決方法

## 1. ✅ 正しい関数を実行していますか？

### 確認手順：

1. Apps Script エディタで、実行ボタンの**左側**にあるドロップダウンを確認
2. **`onOpen`** 関数が選択されていることを確認

```
[onOpen ▼] [実行] [デバッグ]
```

### ❌ 間違った関数を実行している場合：

- `myFunction`や他の関数が選択されている
- **解決方法**: ドロップダウンから **`onOpen`** を選択して実行

## 2. 🔑 権限が正しく許可されていますか？

### 実行時の権限確認手順：

1. **`onOpen`** を選択して **「実行」** ボタンをクリック
2. 以下のダイアログが表示されるはずです：

```
┌─────────────────────────────────────┐
│ 承認が必要です                       │
│                                     │
│ このスクリプトには次の権限が必要です： │
│ • スプレッドシートの表示と編集        │
│ • 外部サービスへの接続               │
│                                     │
│ [権限を確認] [キャンセル]            │
└─────────────────────────────────────┘
```

3. **「権限を確認」** をクリック
4. Google アカウントを選択
5. 警告画面が表示されたら：
   - **「詳細」** をクリック
   - **「○○（安全ではないページ）に移動」** をクリック
   - **「許可」** をクリック

### 💡 権限許可が完了すると：

- 実行ログに「実行完了」と表示される
- エラーメッセージが表示されない

## 3. 🔄 スプレッドシートの再読み込み

権限許可後、以下を実行してください：

1. **スプレッドシートのタブ**に戻る
2. **F5 キー**を押すか、ブラウザの更新ボタンをクリック
3. メニューバーを確認：**「画像ツール」**が表示されているか確認

## 4. 📋 実行ログの確認

Apps Script エディタで実行ログを確認：

1. **「実行」** ボタンの右側にある **「実行ログ」** をクリック
2. エラーメッセージがないか確認

### よくあるエラーと解決方法：

#### エラー: `HtmlService.createHtmlOutputFromFile('Sidebar') に失敗しました`

**原因**: Sidebar.html ファイルが正しく作成されていない  
**解決方法**: Sidebar.html ファイルを再作成

#### エラー: `getProperty('OPENAI_API_KEY') が null です`

**原因**: OpenAI API キーが設定されていない  
**解決方法**: プロジェクトの設定で API キーを設定

#### エラー: OAuth2 スコープエラー

**症状**: `script.container.ui` などのスコープエラーが表示される  
**原因**: `appsscript.json` で古いまたは無効なスコープが指定されている  
**解決方法**:

1. **推奨**: `appsscript.json` からスコープ設定を削除（自動検出に任せる）
2. または正しいスコープに更新：
   - スプレッドシート: `https://www.googleapis.com/auth/spreadsheets`
   - 外部リクエスト: `https://www.googleapis.com/auth/script.external_request`

## 5. 🔍 段階的な確認手順

### ステップ 1: コードの確認

1. `コード.gs` ファイルを開く
2. `onOpen` 関数が存在することを確認：
   ```javascript
   function onOpen() {
     const ui = SpreadsheetApp.getUi();
     ui.createMenu("画像ツール")
       .addItem("サイドバーを開く", "showSidebar")
       .addItem("設定を確認", "checkSettings")
       .addToUi();
   }
   ```

### ステップ 2: 手動テスト

1. Apps Script エディタで **`checkSettings`** 関数を実行
2. 設定確認ダイアログが表示されるかテスト

### ステップ 3: ブラウザの確認

1. **シークレットモード**で Google スプレッドシートを開く
2. 同じ手順を試す（拡張機能の干渉を排除）

## 6. 🚨 よくある間違い

### ❌ 間違い 1: Code.gs ファイルの内容が不完全

**症状**: 実行時にエラーが発生  
**解決方法**: Code.gs の内容を完全にコピー&ペーストし直す

### ❌ 間違い 2: Sidebar.html ファイルが存在しない

**症状**: showSidebar 関数でエラー  
**解決方法**: HTML ファイルを正しく作成

### ❌ 間違い 3: 権限を部分的にしか许可していない

**症状**: 一部の機能が動作しない  
**解決方法**: すべての権限を許可し、スクリプトを再実行

## 7. 🔧 最終的な解決方法

上記の手順で解決しない場合：

### 完全リセット手順：

1. **新しいスプレッドシート**を作成
2. **Apps Script プロジェクト**を最初から作成
3. **コードを再度コピー&ペースト**
4. **権限を再度許可**

### 代替テスト方法：

1. Code.gs に以下のテスト関数を追加：
   ```javascript
   function testMenu() {
     SpreadsheetApp.getUi().alert(
       "メニューテスト",
       "テスト成功！",
       SpreadsheetApp.getUi().ButtonSet.OK
     );
   }
   ```
2. `testMenu` 関数を実行してアラートが表示されるか確認

## 8. 📞 まだ解決しない場合

以下の情報を確認してください：

1. **ブラウザ**: Chrome、Firefox、Safari のいずれか
2. **Google アカウント**: 管理者権限があるか
3. **ネットワーク**: 企業ネットワークでブロックされていないか
4. **実行ログ**: 具体的なエラーメッセージ

この情報を基に、さらに詳しいサポートを提供できます。
