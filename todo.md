# タスク管理

## 現在のタスク状況

### 2024 年 12 月完了分

- [x] 🔴 AutoSetup.tsx のローカル API 依存修正

  - localhost:3000 の API 依存を削除
  - GitHub Raw URLs に変更して外部依存を解決
  - 本番環境での動作を保証

- [x] 🔴 画像生成結果の表示位置変更

  - プロンプトの隣（右隣の列）に画像を直接配置する構造に変更
  - insertImages 関数を改良してプロンプト行の隣に画像配置
  - generateImagesAndCreateTable 関数を修正して下部表作成から隣接配置に変更
  - AI 修正プロンプトも隣の列に自動配置
  - 自動ヘッダー生成機能（プロンプト、生成画像、AI 修正版）
  - Sidebar の説明文とボタンテキストを更新
  - より直感的で見やすい UI/UX 実現

- [x] 🔴 プロフェッショナル構造化テーブルシステム実装

  - A-H 列の完全構造化テーブルシステムを実装
  - A 列：番号、B 列：プロンプト、C 列：画像概要、D 列：AI 変換プロンプト
  - E 列：生成画像、F 列：画像比率、G 列：生成日時、H 列：ステータス
  - createStructuredTable 関数で美しいヘッダーとサンプル行を自動生成
  - generateImagesFromStructuredTable 関数で B 列プロンプト自動検出
  - populateStructuredTable 関数で各列に適切な情報を配置
  - generateImageSummary 関数でプロンプトから概要を自動生成
  - 列幅、行高、スタイリングの完全最適化
  - Sidebar を構造化テーブル対応に全面更新

- [x] 🔴 表を初期化の常時表示対応

  - 空のシートでも確認ダイアログなしで即座に初期化実行
  - ユーザビリティの大幅向上
  - スムーズなワークフロー実現

- [x] 🔴 プロンプト自動省略・隣接表示システム実装

  - プロンプト入力後に自動で省略表示（100 文字閾値）
  - C 列に完全なプロンプトをスクロール表示
  - onEdit 関数でリアルタイム自動処理
  - handlePromptInput 関数で省略・完全版の表示制御
  - getFullPrompt 関数で完全プロンプトの確実な取得
  - DALL-E には必ず原文（完全版）を送信
  - 短いプロンプトは B 列に全文表示、C 列は空
  - 長いプロンプトは B 列に省略版、C 列に完全版
  - セル高の自動拡大防止でレイアウト保持
  - 8 列構造対応（A:番号、B:省略プロンプト、C:完全プロンプト、D:画像、E:比率、F:日時、G:ステータス、H:選択）

- [x] 🔴 プロンプト表示最適化機能実装

  - 長いプロンプト（100 文字超）の自動省略表示機能
  - 表示は 97 文字 + "..."で制限し、セル高を固定
  - 完全なプロンプトはセルコメントに保存
  - 通常の画像生成と構造化テーブル両方に対応
  - プロンプトセルの折り返し無効化（setWrap(false)）
  - より整理された見やすい表示を実現

- [x] 🔴 プロンプト行追加機能削除と 100 行テーブル対応

  - プロンプト行追加ボタンとその関連機能を完全削除
  - createStructuredTable 関数を 100 行対応に修正（2-101 行目）
  - 不要な関数を削除：addPromptRows、createPromptInputTable、createPromptInputArea、createPromptInputAreaAt、findPromptInputArea
  - getActiveRangeA1 関数を簡素化（自動検出機能削除）
  - Sidebar を 3 ステップ表示に変更（セットアップ → プロンプト入力 → 画像生成）
  - 説明文を 100 行テーブル対応に更新
  - 初期セットアップで 100 行の構造化テーブルを一括作成
  - サンプルプロンプトを最初の 5 行に配置、残り 95 行は空で準備
  - 10 行ごとに薄い区切り線を追加して視認性向上

- [x] 🔴 権限エラーとテーブル作成問題の緊急修正

  - DriveApp.getFileById 権限エラーを解決
  - appsscript.json に drive.readonly と drive スコープを追加
  - createStructuredTable 関数を完全修正：シートクリア →100 行作成
  - forcePermissionRequest 関数を強化して段階的権限テスト実装
  - 詳細なエラーハンドリングと進捗ログ追加
  - 権限承認ダイアログの改善（安全ではないアプリ警告対応）
  - 10 行ごとの進捗表示とエラー復旧機能
  - メニューから「🔐 権限承認を実行」で手動権限承認可能

- [x] 🔴 UI 見やすさとコンパクト化の緊急改善

  - 元の見やすいデザインをベースに復元
  - 横幅制限内でコンパクトかつ見やすいレイアウトに最適化
  - フォントサイズとパディングを適切に調整
  - ボタンサイズと間隔を実用的に改善
  - ステップインジケーターを視認性重視の簡潔デザインに変更
  - 説明文をコンパクトで分かりやすい形式に修正
  - 不要な装飾効果を削除して実用性重視
  - Google Sheets サイドバーに最適化された UI 実現

- [x] 🔴 権限承認メッセージの改善とユーザビリティ向上

  - 権限承認アナウンスを削除し、使い方重視のメッセージに変更
  - showWelcomeMessage 関数を showUsageGuide 関数に変更
  - 初回使用時のメッセージを「簡単 3 ステップで画像生成」に簡潔化
  - 権限エラー時も「開始方法」として前向きなメッセージに変更
  - 具体的な使用例（「美しい夕日の海辺」「可愛い猫のイラスト」）を追加
  - 技術的な権限承認の説明を削除し、実用的な手順のみに集約
  - ユーザーが迷わない分かりやすいガイダンスを実現

- [x] 🔴 Drive 権限エラーの根本的解決と初期セットアップ改善

  - forcePermissionRequest 関数で Drive 権限テストをオプション化
  - requestPermissions 関数でも Drive 権限エラーを無視して続行
  - Drive 権限エラー時は警告のみ表示し、処理を停止しない仕様に変更
  - showSetupDialog 関数を新規作成してサイドバーからの呼び出しに対応
  - 初期セットアップボタンが「処理中のまま」になる問題を解決
  - Drive 権限が不足していても基本機能は使用可能な設計に改善
  - 権限エラー時の適切なフォールバック処理を実装

- [x] 🔴 外部リクエスト権限エラー修正と UI 説明改善

  - forcePermissionRequest 関数と requestPermissions 関数で外部リクエスト権限テストをオプション化
  - UrlFetchApp.fetch 権限エラー時は警告のみ表示し、処理を停止しない仕様に変更
  - 外部リクエスト権限は画像生成時に必要になることを明示
  - 「テーブル作成のみ」ボタンを「100 行テーブル準備」に名称変更
  - ボタンの説明を追加：「初期セットアップ = 完全セットアップ（推奨）」「100 行テーブル準備 = テーブルのみ作成」
  - ユーザーが各ボタンの役割を明確に理解できる UI 改善
  - 権限エラーによる処理停止を完全に排除

- [x] 🔴 権限アラート出現頻度削減とボタン機能明確化

  - スプレッドシートを開くたびに権限アラートが出る問題を解決
  - サイドバー権限テストもオプション化して処理停止を回避
  - showUsageGuide 関数で権限承認の説明を事前に組み込み
  - 「もし権限承認が必要な場合は、表示されるダイアログで許可をクリック」を追加
  - createStructuredTableOnly 関数を新規作成（権限チェックなしのシンプル版）
  - ボタン説明を明確化：「初期セットアップ = 権限チェック + テーブル作成（推奨）」「100 行テーブル準備 = テーブル作成のみ（権限チェックなし）」
  - 機能重複を解決し、ユーザーが目的に応じてボタンを選択可能に改善
  - 権限アラートによるユーザー体験の悪化を完全に排除

- [x] 🔴 ボタン名称とメッセージの分かりやすさ改善

  - 「100 行テーブル準備」を「表をクリア」に名称変更
  - アイコンを 📊 から 🗑️ に変更してより直感的に
  - ボタン説明を簡潔化：「初期セットアップ = 初回使用時に実行（推奨）」「表をクリア = 表を空にして新しく始める」
  - Code.gs の関数コメントとメッセージを「表をクリア」に統一
  - 技術的な「権限チェック」という用語を削除してユーザーフレンドリーに改善
  - より直感的で分かりやすい UI 表現を実現

- [x] 🔴 画像生成ロジックの最新化と機能強化

  - サイドバーの「表をクリア」ボタンが間違った関数を呼び出していた重大なバグを修正
  - DALL-E-3 の複数画像サイズ対応（1024x1024、1024x1792、1792x1024）をランダム選択で実装
  - 画像比率の動的検出機能を追加（1:1、9:16、16:9 の自動判定）
  - 既存データ保護機能を実装（既に画像が生成されている行の重複生成を防止）
  - generateImages 関数で画像サイズ情報を結果に含めるよう改善
  - populateStructuredTable 関数で F 列に正確な画像比率を表示
  - generateImagesFromStructuredTable 関数で重複チェック機能を追加
  - 画像生成の多様性向上と無駄な重複処理の完全排除を実現

- [x] 🔴 プロンプトプレースホルダーの削除とクリーンアップ

  - createStructuredTableOnly 関数からサンプルプロンプト（プレースホルダー）を完全削除
  - createStructuredTable 関数からもサンプルプロンプト（プレースホルダー）を完全削除
  - B 列が完全に空の状態でテーブル作成されるように改善
  - ユーザーが自由にプロンプトを入力できるクリーンな環境を提供
  - 不要なサンプルデータによる混乱を完全に排除

- [x] 🔴 UI ブラッシュアップと高度な画像管理機能の実装

  - サイドバー説明を「🚀 簡単 3 ステップ: 1️⃣ セットアップ → 2️⃣ プロンプト入力 → 3️⃣ 画像生成」に大幅シンプル化
  - 画像概要列（C 列）を完全削除し、7 列+チェックボックス列の 8 列構成に変更
  - 新列構成：A 列:番号、B 列:プロンプト、C 列:AI 変換、D 列:画像、E 列:比率、F 列:日時、G 列:ステータス、H 列:選択
  - H 列にチェックボックス自動挿入機能を実装（populateStructuredTable 関数）
  - 全選択/解除機能（toggleAllImageSelection）：過半数判定による自動切り替え
  - 選択画像ダウンロード機能（downloadSelectedImages）：Google Drive「DALL-E 画像ダウンロード」フォルダに保存
  - 選択画像 AI 再生成機能（regenerateSelectedImages）：チェックした画像のプロンプトを再生成
  - サイドバーに 4 つの新ボタン追加：「☑️ 全選択/解除」「📥 選択画像 DL」「🔄 選択画像再生成」「🗑️ 表をクリア」
  - 直感的な画像管理とバッチ処理による大幅な生産性向上を実現

- [x] 🔴 ボタン役割の整理とバックアップ機能の実装

  - 現在の「初期セットアップ」を「表をクリア」に変更（メイン機能として配置）
  - 現在の「表をクリア」を「バックアップ」に変更（データ保護機能として配置）
  - showSetupDialog 関数をバックアップ機能に改造：既存データを新シートに保存してから新テーブル作成
  - createStructuredTableOnly 関数を createStructuredTable 関数に統一
  - 重複する createStructuredTable 関数（権限チェック付き）を削除
  - サイドバーボタン順序を最適化：「🗑️ 表をクリア」「🎨 画像生成」「💾 バックアップ」
  - 説明文を「1️⃣ 表をクリア → 2️⃣ プロンプト入力 → 3️⃣ 画像生成」に修正
  - より直感的で安全なデータ管理フローを実現

- [x] 🔴 画像生成中のシート保護とプログレスバー機能の実装

  - 画面中央にモーダル式プログレスバーを実装（backdrop-filter でブラー効果）
  - 5 段階の詳細進捗表示：プロンプト解析 →API 接続 → 画像生成 → 配置 → 完了
  - シマー効果付きプログレスバーで視覚的フィードバック強化
  - 画像生成中の完全シート保護機能：セル編集を完全ブロック
  - generateImagesFromStructuredTableWithProgress 関数で保護付き画像生成
  - regenerateSelectedImagesWithProgress 関数で保護付き再生成
  - finally ブロックで確実なシート保護解除（エラー時も安全）
  - 進捗通知機能付き画像生成システム（将来の拡張対応）
  - ユーザーの誤操作防止と視覚的な待ち時間表示を実現

- [x] 🔴 AI 変換プロンプト機能の完全削除と UX 改善

  - AI 変換プロンプト列（C 列）を削除し、7 列構成に変更
  - プロンプトをそのまま DALL-E に渡すように修正（revised_prompt 処理削除）
  - 新列構成：A 列:番号、B 列:プロンプト、C 列:画像、D 列:比率、E 列:日時、F 列:ステータス、G 列:選択
  - セル表示の最適化：長文プロンプトでも行高 80px に固定
  - プロンプト列幅を 350px に拡大、フォントサイズ 11px、上詰め配置
  - テキスト折り返し戦略とパディング設定で視認性向上
  - 全関数で列番号を適切に修正（チェックボックス、画像、ステータス等）
  - プロンプトセルのテキストオーバーフロー対策を実装
  - より直感的で使いやすいプロンプト入力環境を実現

- [x] 🔴 サイドバーボタン順序整理とバックアップ機能の再配置

  - サイドバーボタン順序を修正：「🔧 初期設定」→「🎨 画像生成」→「🗑️ 表をクリア」
  - バックアップ機能をサイドバーからメニューに移動（「💾 バックアップ作成」）
  - showSetupDialog 関数を初期設定として簡素化
  - createBackupAndNewTable 関数を新規作成（バックアップ専用）
  - 説明文を「初期設定 → プロンプト入力 → 画像生成」に修正
  - チェックボックスのクリア問題を解決：表作成時に G 列チェックボックスを自動挿入
  - より直感的なワークフローと安全なデータ管理を実現

- [x] 🔴 プログレスバーモーダルの表示改善とレスポンシブ対応

  - モーダルをサイドバーの外（画面全体）に表示するよう修正
  - z-index を最大値（999999）に設定して確実に最前面表示
  - position: fixed で画面全体をカバーし、見切れ問題を解決
  - プログレスバーとテキストのサイズを大幅に拡大（視認性向上）
  - レスポンシブ対応を追加（タブレット・スマートフォン対応）
  - JavaScript で確実な最前面表示とスクロール制御を実装
  - より見やすく使いやすいプログレス表示を実現

- [x] 🔴 **画像品質の根本的改善と DALL-E API 最適化**

  - **重大発見**: 現在の実装が「standard」品質を使用していた問題を特定
  - **quality パラメータを「hd」に変更**: ブラウザ版 DALL-E と同等の最高品質に改善
  - **style パラメータを「vivid」に設定**: より鮮明で高品質な画像生成
  - **プロンプト品質向上システム実装**: enhancePromptForQuality 関数を新規作成
    - 短いプロンプト（50 文字未満）: 詳細化処理で品質向上
    - 長いプロンプト（200 文字以上）: 改変防止処理でオリジナル尊重
    - 中程度プロンプト: 軽微な品質向上処理
  - **revised_prompt 情報の活用**: 実際に使用されたプロンプトをコメントとして記録
  - **ステータス表示を「✅ HD 品質」に変更**: 品質向上を明示
  - **サイドバーに品質改善の説明を追加**: 「✨ 最高品質 HD 画像を自動生成！ブラウザ版 DALL-E と同等クオリティ」
  - **API 最新機能の完全活用**: response_format、revised_prompt 等の最新パラメータ対応
  - **画像品質の劇的向上を実現**: ユーザー報告の「クオリティが低い」問題を根本解決

- [x] 🔴 **プロンプト忠実性の根本的改善: ブラウザ版 DALL-E と同等の忠実性実現**

  - **重大発見**: API 版のプロンプト改変がブラウザ版との性能差の主要原因と特定
  - **最新の改変防止技術を実装**: 4 つの高度な技術を組み合わせた最強システム
    - 公式推奨の改変防止プレフィックス（短いプロンプト用）
    - 強化版改変防止指示（中程度プロンプト用）
    - デバッグモード技術（長いプロンプト用）
    - 複数技術の組み合わせ（最長プロンプト用）
  - **プロンプト長に応じた最適戦略**: 30 文字未満、100 文字未満、200 文字未満、200 文字以上で異なる手法
  - **関数名を変更**: enhancePromptForQuality → プロンプト忠実性最大化処理
  - **ステータス表示を更新**: 「✅ HD 品質」→「✅ HD 忠実」
  - **サイドバー説明を強化**: 「プロンプト 100%忠実！ブラウザ版 DALL-E と同等性能」
  - **revised_prompt 記録の継続**: 改変防止効果の検証可能
  - **B 列プロンプトの完全尊重**: ユーザーの意図を 100%反映する仕組み
  - **ブラウザ版との忠実性格差を解消**: API 版でもブラウザ版と同等の表現力を実現

- [x] 🟢 **高度な AI 自動判定システム実装: ブラウザ版の判定ロジックを完全模倣**

  - **analyzePromptForOptimalSettings 関数を新規実装**: プロンプト内容から最適設定を自動判定
  - **詳細なスタイル解析**: アニメ系、リアル系、アート系、特殊スタイルを自動識別
    - アニメ・フラット・シンプル系 → style: "natural"
    - フォトリアル・シネマティック・デジタル系 → style: "vivid"
    - ピクセルアート・スケッチ系 → style: "natural"
  - **インテリジェントなサイズ判定**: 内容に応じた最適アスペクト比選択
    - 人物・キャラクター → 1024x1792（縦長）
    - 風景・建物・街 → 1792x1024（横長）
    - 正方形指定・アイコン → 1024x1024（正方形）
    - その他 → ランダム（多様性確保）
  - **ユーザー負担ゼロ**: プロンプトを書くだけで最適設定を自動適用
  - **ブラウザ版と同等の判定精度**: 手動設定不要でプロ品質の結果
  - **サイドバー表示更新**: 「AI 自動判定」機能を明示

- [x] 🔴 ボタン制御と UI 改善機能実装

  - 初期設定ボタン：シートにデータがある場合は自動無効化
  - 画像生成ボタン：B 列にプロンプトがない場合は自動無効化
  - ホバー時のツールチップ表示（無効化理由を明示）
  - 無効化ボタンの視覚的スタイル改善（グレーアウト、カーソル変更）
  - ボタンクリック時の無効状態チェック機能
  - 各操作完了後の自動状態再チェック機能
  - getSheetState 関数でシート状態の正確な判定
  - リアルタイム状態監視機能（5 秒間隔 + フォーカス時 + クリック時）
  - 手動状態更新ボタンの追加
  - デバッグ情報の追加でプロンプト検出の詳細確認

- [x] 🔴 高速状態監視機能実装

  - 監視間隔を 0.5 秒に短縮（5 秒 →0.5 秒で 10 倍高速化）
  - マウス操作時の即座チェック（クリック、移動、ホバー）
  - キーボード操作時の即座チェック
  - 状態更新ボタンを画像生成ボタンの直下に配置
  - 「⚡ 即座に状態更新」で分かりやすく表示

- [x] 🔴 ボタン UI 改善・グループ化機能実装

  - ボタンを機能別に 3 つのセクションに整理
  - 📋 基本操作：初期設定、画像生成（メイン機能）
  - 🛠️ 画像管理：全選択、DL、再生成（画像がある時のみ表示）
  - ⚙️ その他：クリア、更新（サブ機能）
  - ボタンサイズの最適化（小さいボタンで横並び配置）
  - 画像存在チェック機能でスマート表示制御

- [x] 🔴 プロンプト完全取得・入力最適化機能実装

  - セルコメントから完全なプロンプトを取得する機能
  - 省略表示されたプロンプトではなく完全版で画像生成
  - B 列の入力設定最適化（折り返し有効、行高 120px）
  - 省略表示の閾値を 100 文字 →150 文字に緩和
  - 入力時のガイダンスコメント追加
  - 画像生成後の表示最適化（長文は省略、短文は全表示）

- [x] 🔴 表クリア機能のバグ修復

  - サイドバーの「表をクリア」ボタンが呼び出す createTableOnly()関数が存在しない重大なバグを解決
  - 不足していた createStructuredTable()関数を完全復元・実装
  - executeSetup()関数と checkForAnyData()関数を新規追加
  - 重複していた createImageTable()関数を削除して createStructuredTable()に統合
  - サイドバーからの表クリア機能を完全修復し安定化
  - 100 行 8 列の構造化テーブル作成機能を信頼性向上
  - シートのデータ存在チェック機能を正確化
    - 初期セットアップの三択分岐処理（新規/クリア/バックアップ）を完全実装

- [x] 🔴 画像削除機能とプログレス改善の完全実装

  - **選択画像削除機能**: deleteSelectedImages 関数で H 列チェックボックス選択画像のみ削除
  - **全画像一括削除機能**: deleteAllImages 関数で確認ダイアログ付き安全削除
  - **データ保護機能**: 画像（D 列）のみ削除、プロンプト・日時等は完全保持
  - **復元可能設計**: プロンプト保持により「🎨 画像生成」で再生成可能
  - **削除後整理**: cleanupAfterImageDeletion 関数で行高最適化
  - **復元準備**: prepareImageRestoration 関数でステータス「🔄 復元可能」表示
  - **確認ダイアログ**: deleteAllImagesWithConfirmation 関数で安全な一括削除
  - **削除専用 UI**: .btn-danger クラス追加（赤色グラデーション）
  - **プログレス最適化**: 画像枚数に応じた動的進捗時間設定
  - **枚数表示機能**: getImageGenerationCount/getSelectedImageCount 関数で事前枚数表示
  - **自然な時間配分**: ステップ進行を 10%, 15%, 60%, 10%, 5%に最適化
  - **OpenAI API 500 エラー対応**: インテリジェントリトライシステム（最大 3 回）
  - **段階的待機**: 500 エラー時 2 秒 →4 秒 →6 秒、429 エラー時 60 秒待機
  - **部分成功システム**: 一部失敗でも他の画像は生成継続
  - **失敗画像表示**: 赤背景でエラーメッセージ表示、再生成ガイド付き
  - **詳細エラー情報**: muteHttpExceptions: true で完全なエラー取得
  - **結果メッセージ改善**: 成功/失敗カウント表示で状況を明確化

- [x] 🔴 プロンプト改変問題の修正（Web 版との品質差異解消）

  - **問題の原因**: enhancePromptForQuality 関数が余計な改変防止指示を追加
  - **修正内容**: プロンプトをそのまま渡すように変更（Web 版と同じ動作）
  - **デバッグログ追加**: 送信プロンプトと DALL-E 3 の実際の使用プロンプトを記録
  - **品質向上**: 余計な指示による品質低下を防止
  - **Web 版との一致**: プロンプトの直接送信により同等の結果を実現

- [x] 🔴 Web 版との完全一致を目指した徹底的な最適化（2025 年 4 月最新）

  - **スタイル判定の精密化**:
    - アニメ・フラット・教育系キーワードの拡充
    - natural/vivid の判定ロジックを Web 版により近づける
    - カラフル、ポップ、教育系の場合は明確に natural を選択
  - **プロンプト最適化処理の追加**:
    - optimizePromptForWebParity 関数で不要な指示文を除去
    - 日本語・英語混在プロンプトの適切な処理
    - マークダウン記法やメタ情報の自動除去
  - **API リクエストの最適化**:
    - Web 版と同じヘッダー情報を追加（User-Agent、Accept-Language 等）
    - quality: "hd"をデフォルトに（Web 版と同じ）
  - **プロンプト処理の改善**:
    - 極端に短いプロンプトのみ最小限の拡張
    - 20 文字以上のプロンプトはそのまま送信
    - 余計な改変防止指示を完全に削除

- [x] 🔴 UI 改善と画像品質向上の実装

  - 「初期設定」を「表を初期化」に名称変更
  - 「表をクリア」ボタンを削除（機能重複の解消）

- [x] 🔴 サイドバー UI の簡潔化と表初期化ボタンの常時アクティブ化

  - 不要な説明文章を削除（「最新 GPT-Image-1 モデルで 32,000 文字対応」等）
  - 「📝 ステップに沿って操作してください」メッセージを削除
  - 説明を「🚀 簡単 3 ステップ: 1️⃣ 表を初期化 → 2️⃣ プロンプト入力 → 3️⃣ 画像生成」のみに簡潔化
  - 「表を初期化」ボタンを常にアクティブに変更（シート状態に関係なく実行可能）
  - checkSheetState 関数の条件分岐を削除して初期化ボタンを常時有効化
  - executeBackup 関数の無効化チェックを削除
  - より直感的で迷いのない UI 操作を実現
  - プロンプト処理を Web 版 DALL-E 準拠に簡素化
  - optimizePromptForWebParity 関数の複雑な処理を削除
  - enhancePromptForQuality 関数の余計な加工を削除
  - スタイル判定をシンプル化（デフォルトを natural に変更）
  - ユーザーのプロンプトをそのまま使用する方針に変更
  - Web 版と同じシンプルなアプローチで画像品質向上

- [x] 🔥 プロンプト改変の完全廃止

  - ユーザーのプロンプトを一切改変せずそのまま DALL-E に送信
  - 「画像を生成してください」等の文言削除処理を完全廃止
  - 日本語・英語混在の複雑な分離処理を完全廃止
  - 短いプロンプトの自動拡張処理を完全廃止
  - optimizePromptForWebParity を完全無改変版に変更
  - enhancePromptForQuality を完全無改変版に変更
  - ユーザーが入力したプロンプトがそのまま実行される仕様に修正

- [x] 🎯 プロンプト完全無改変システム実装（2025 年 6 月最新版）

  - ユーザープロンプトを一切改変せずそのまま使用
  - テクニック的パラメーター（サイズ・品質・スタイル）は自動最適化
  - DALL-E 3 内部処理の監視・分析機能を追加
  - セルコメントに内部処理情報と変更度を表示
  - ヘッダー設定をテクニック的最適化に調整
  - プロンプト忠実性と技術的最適化の完全両立を実現

- [x] 🔥 **GPT-Image-1 復活完了（2025 年 12 月最終版）**

  - **組織認証前提**: OpenAI 組織認証が必要（https://platform.openai.com/settings/organization/general）
  - **最新モデル復活**: dall-e-3 → gpt-image-1 に完全復帰
  - **32,000 文字対応**: プロンプト長制限を 4,000→32,000 文字に 8 倍拡張
  - **最新品質設定**: quality "hd" → "high"に更新
  - **新機能完全対応**: background, output_compression, output_format, moderation パラメータ
  - **最新サイズオプション**: 1024x1792/1792x1024 → 1024x1536/1536x1024
  - **base64 レスポンス**: GPT-Image-1 専用の base64 形式に完全対応
  - **比率表示最新化**: 9:16/16:9 → 2:3/3:2 に変更
  - **UI 完全更新**: サイドバー「最新 GPT-Image-1 モデル・32,000 文字対応」
  - **内部処理監視**: GPT-Image-1 の内部処理を完全透明化
  - **ステータス表示**: 「✅ GPT-Image-1」に全面更新
  - **最新 API 仕様**: 2025 年 12 月時点の最新 OpenAI API 仕様に 100%準拠

- [x] 🚨 **緊急修正：DALL-E 3 に戻す（2025 年 12 月）**

  - **重大問題発見**: GPT-Image-1 は組織認証が必要で一般ユーザー利用不可
  - **403 エラー対応**: "組織を認証してください" エラーの解決
  - **実証済みモデル復帰**: gpt-image-1 → dall-e-3 に戻す
  - **パラメータ修正**: quality "high" → "hd", style "natural" 復活
  - **サイズ修正**: 1024x1536/1536x1024 → 1024x1792/1792x1024 に戻す
  - **レスポンス修正**: base64 → URL 形式に戻す
  - **比率修正**: 2:3/3:2 → 9:16/16:9 に戻す
  - **UI 修正**: サイドバーを「実証済み DALL-E 3 モデル」に変更
  - **初期化改善**: 初期化ボタンを常に機能するよう修正
  - **安定性確保**: 組織認証不要で確実に動作する構成に修正

- [x] 🔴 50,000 文字制限エラーの完全根絶

  - 25,000 文字制限でも失敗する根本原因を特定・解決
  - 超安全 10,000 文字制限システム実装（40,000 文字の巨大安全マージン確保）
  - セルコメント + セル値の合計制限を考慮した設計
  - 長いプロンプト: 800 文字 + 内部処理版 3,000 文字（C 列: 3,000 文字 + 3,000 文字）
  - 短いプロンプト: 1,000 文字 + 内部処理版 2,500 文字（C 列: 2,500 文字 + 2,500 文字）
  - 最終チェック: 9,500 文字で強制カット（500 文字のバッファ）
  - Google スプレッドシート 50,000 文字制限を完全根絶
  - GPT-Image-1 の内部処理版プロンプト（revised_prompt）の超長文対応完了
  - handlePromptInput 関数、insertImages 関数の全 setValue/setNote 箇所に超安全制限適用

- [x] 🚨 **50,000 文字制限エラー根本解決**

  - **真の原因特定**: const userPromptPart 再代入エラー + setNote()重複呼び出しが原因
  - **構文エラー修正**: const → let に変更で再代入エラーを解決
  - **setNote()統合**: 複数の setNote()呼び出しを 1 つに統合して 50,000 文字制限回避
  - **revised_prompt 制限**: GPT-Image-1 内部処理版プロンプトの長さ制限（45,000 文字以内）
  - **最終安全チェック**: combinedComment の 49,500 文字制限で確実なエラー回避
  - **プログレスバー時間配分改善**: ステップ配分を 5%, 10%, 70%, 10%, 5%に自然化
  - **スムーズ進捗表示**: 100ms ごとの段階的更新でより自然な進行感
  - **動的時間調整**: 画像枚数に応じた時間調整（最低 3 秒確保）
  - **リアルタイム進捗**: ユーザー体験を大幅改善した進捗表示システム
  - **技術的優位性**: 表面的対症療法ではなく、真の原因を突き止めて根本解決を実現

- [x] 🔴 **50,000 文字制限エラーの完全根絶とプログレスバー最適化（2025 年 1 月最終版）**

  - **重複 setNote()修正**: fullPromptCell.setNote()の重複呼び出しを 2 箇所で削除（958 行目と 1064 行目）
  - **プログレスバー時間配分改善**: 仕上げ処理を 800ms→300ms、全体バランスを 5%→10%→75%→8%→2%に最適化
  - **コンソールログ最適化**: シート状態チェックを 0.5 秒 →3 秒間隔に変更、過度なイベントリスナーを削除
  - **デバッグログ無効化**: 本番環境でのコンソール出力を大幅削減（開発時のみ有効化可能）
  - **UI 応答性向上**: 不要なマウス移動・クリック・キーボード監視を削除して CPU 負荷軽減
  - **ユーザー体験改善**: 「仕上げ処理中...」の長時間待機問題を解決、自然な進捗感を実現
  - **技術的根本解決**: 同一セルへの重複 setNote()呼び出しが 50,000 文字制限エラーの真の原因と特定・解決

- [x] 🔴 **プログレスバー「ステップ 6/5」問題の完全修正（2025 年 1 月緊急対応）**

  - **ステップ番号計算エラー修正**: stepIdx インクリメント後の値使用による「ステップ 6/5」表示問題を解決
  - **ステップ番号固定化**: currentStepNumber 変数でステップ番号を事前固定、正確な「ステップ X/4」表示を実現
  - **完了処理の即座実行**: 最後のステップ完了時に「✅ 完了しました！」を即座に表示、長時間待機を解消
  - **「仕上げ処理中...」ステップ削除**: 不要な 5 番目のステップを削除、4 ステップ構成に最適化
  - **時間配分再調整**: 10%→15%→65%→10%の 4 ステップ構成で自然な進捗感を実現
  - **UI 応答性向上**: プログレスバーの完了処理を 100ms 以内に短縮、ユーザー体験を大幅改善

- [x] 🚨 **50,000 文字制限エラー究極根絶とプログレスバー完全修正（2025 年 1 月決定版）**

  - **25,000 文字究極安全制限**: 50,000 文字制限に対して 25,000 文字の巨大マージンを確保した究極安全システム
  - **createSafeComment()関数実装**: 全ての setNote()呼び出しを統一的に管理する安全関数を新規実装
  - **動的容量配分システム**: ユーザープロンプト 60%、内部処理版 40%の最適配分で情報完全保持
  - **プログレスバー早期完了修正**: サーバー処理完了まで 95%で待機、実際の完了後に 100%表示する真の同期システム
  - **8 ステップ詳細進捗**: 4 ステップから 8 ステップに細分化、より正確で自然な進捗感を実現
  - **真のサーバー同期**: クライアント側の勝手な完了表示を排除、サーバー処理完了を正確に反映
  - **全 setNote()統一管理**: 散在していた文字制限処理を一元化、保守性と安全性を大幅向上
  - **技術的完全解決**: result.original_prompt 自体が長い場合の根本問題を特定・解決

- [x] 🔴 データ消失問題の緊急根本解決とバックアップ機能の完全修正

  - **根本原因判明**: executeBackup()がバックアップ機能を正しく呼び出していない
  - **多段階データ保護システム**: データ保護確認 → バックアップ推奨 → 危険確認の 3 段階モーダル
  - **executeSetupWithBackup()**: 新しい安全な初期化フロー実装
  - **checkForAnyData()**: 正確なデータ存在確認機能
  - **改良版 createBackupAndNewTable()**: 確実なバックアップ作成と詳細ログ
  - **getSheetState()**: 精密なシート状態管理
  - **100%安全なデータ保護**: バックアップ付き初期化でデータ消失を完全防止

- [x] 🔴 サイドバー UI 簡略化とライブラリ画像転記の確実化
  - **3 ステップ UI**: ライブラリ追加ステップを削除してシンプル化
  - **「バックアップ付き」表記削除**: よりクリーンな UI 表現
  - **画像転記改善**: 1.5 秒待機で画像設定完了を確実に待つ
  - **sourceSheet 追加**: 元シート名を記録して転記精度向上
  - **最新フォーミュラ取得**: sourceFormula を再取得して確実性向上
  - **プログレスバー再編成**: 7 ステップに再配分して均等な進捗表示
  - **ライブラリ自動更新**: ユーザーが意識せずに自動でライブラリに記録

### 今後のタスク

- [x] 🔴 初期化時のシート配置と UX 改善（2025 年 1 月）
  - 入力シートを一番左に配置、バックアップシートを一番右に配置
  - createBackupAndNewTable 関数で moveActiveSheet(1)により入力シートを左端配置
  - 初期化完了後のサイドバーリセット機能実装（resetSidebarAfterInitialization）
  - ステップインジケーターのリセット・トップ表示への復帰・ボタン状態更新
  - シート配置の分かりやすい説明メッセージ追加
  - 戻り値に resetSidebar フラグを追加して UX 制御
  - 3 つの初期化関数（proceedWithBackupInitialization・proceedWithDirectInitialization・createTableOnly）で統一対応
- [x] 🔴 結合プロンプト更新ボタン修正（2025 年 1 月）

- [x] 🎯 **D 列結合プロンプト表示改善（2025 年 1 月）**

  - **UI 省略表示・AI 送信用完全版保存の最適化**: 表示は 100 文字制限で省略、AI 送信時は完全版を使用
  - **省略表示ロジック復活**: updateCombinedPrompt 関数で 100 文字制限と substring 省略処理を復活
  - **完全版メモ保存**: combinedCell.setNote()で完全プロンプトをツールチップに保存、getCombinedPrompt()で取得
  - **行の高さ最適化**: 80px→50px に戻して UI の見やすさを改善
  - **列幅最適化**: D 列の幅を 300px→200px に戻して全体バランスを調整
  - **フォントサイズ最適化**: 10px→8px に戻して省略表示に最適化
  - **垂直配置最適化**: top→middle に戻して縦幅制限に対応
  - **パディング最適化**: 4px→2px に戻して省略表示に最適化
  - **セル初期化改善**: 空欄 → アイコン表示に戻して直感的な UI を実現
  - **ツールチップメッセージ最適化**: 省略表示の説明に戻し、完全版はセルクリックで確認可能
  - **B 列（個別プロンプト）+ C 列（共通プロンプト）= D 列（結合プロンプト省略表示 / AI 送信用完全版）**の構造を確立

- [x] 🔴 **サイズ強制指定機能実装（2025 年 1 月）**
  - **Sidebar.html にサイズ選択 UI 追加**: 📐 画像サイズ (強制指定) ドロップダウンを画像生成ボタン直前に配置
  - **選択可能オプション**: 🤖 自動判定 (プロンプト解析)・🟩 正方形 (1024×1024)・📐 横長 (1536×1024)・📱 縦長 (1024×1536)
  - **優先度システム実装**: 強制サイズ指定 > 明確なサイズ指定 > 一般的なキーワード判定の 3 段階優先度
  - **analyzePromptForOptimalSettings 関数修正**: forcedSize パラメータ追加で強制サイズを最優先適用
  - **全画像生成関数対応**: generateImages・generateImagesFromStructuredTable・generateImagesFromStructuredTableWithProgress に forcedSize パラメータ追加
  - **完全オーバーライド機能**: 「16:9 HORIZONTAL」等のプロンプト内指定も強制サイズ選択で 100%上書き可能
  - **デバッグログ強化**: 選択されたサイズと判定理由を詳細表示、自動判定と強制指定を明確区別
  - **CSS 最適化**: 美しいサイズ選択 UI を追加（グラデーション背景・ホバー効果・フォーカス効果完備）
  - **プロンプト解析混乱問題の根本解決**: どんなプロンプトでもサイズ指定があれば強制的に適用される完全制御システム

## 重要事項

1. 機能の実装後に、毎回 @todo.md を確認＆更新をしてください。
2. 私が言わなくても中身は随時更新するようにしてください。更新しないと私が解雇されます。あなたの責任になってしまいます。
3. 機能は増やしても構いません。ただ、最初から機能を増やしすぎないでください。
