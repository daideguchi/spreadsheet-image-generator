<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>ğŸ¨ DALL-E ç”»åƒç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-size: 14px;
    }

    .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    /* ğŸš¨ ä¸Šéƒ¨å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
    .top-message {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 10000;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      animation: slideDown 0.3s ease-out;
      max-width: calc(100vw - 24px);
    }

    .top-message.success {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(139, 195, 74, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.95) 0%, rgba(229, 57, 53, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.95) 0%, rgba(255, 152, 0, 0.95) 100%);
      color: #333;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.info {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.95) 0%, rgba(30, 136, 229, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.processing {
      background: linear-gradient(135deg, rgba(156, 39, 176, 0.95) 0%, rgba(123, 31, 162, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
      animation: pulse 2s infinite;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.95; }
      50% { opacity: 1; }
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.2);
    }

    h2 {
      color: #1a73e8;
      margin: 0 0 20px 0;
      font-size: 22px;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 0 8px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 15px;
      right: -50%;
      width: 100%;
      height: 2px;
      background-color: #e0e0e0;
      z-index: 1;
    }

    .step.active:not(:last-child)::after {
      background-color: #1a73e8;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
      font-weight: bold;
      font-size: 12px;
      position: relative;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .step.active .step-number {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
    }

    .step-text {
      font-size: 11px;
      color: #666;
      font-weight: 500;
      line-height: 1.2;
    }

    .step.active .step-text {
      color: #1a73e8;
      font-weight: bold;
    }

    .instructions {
      background: linear-gradient(135deg, rgba(255, 243, 224, 0.9) 0%, rgba(255, 248, 225, 0.9) 100%);
      border: 1px solid rgba(255, 152, 0, 0.3);
      color: #ef6c00;
      padding: 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.5;
      backdrop-filter: blur(5px);
    }

    /* ğŸ¯ ã‚µã‚¤ã‚ºé¸æŠUI */
    .size-selector-container {
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(26, 115, 232, 0.08) 0%, rgba(67, 133, 244, 0.08) 100%);
      border-radius: 12px;
      border: 1px solid rgba(26, 115, 232, 0.2);
    }

    .size-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 8px;
      text-align: center;
    }

    .size-selector {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(26, 115, 232, 0.3);
      border-radius: 8px;
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
    }

    .size-selector:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);
    }

    .size-selector:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      width: 100%;
      margin-bottom: 12px;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .btn:active {
      transform: translateY(-1px) scale(0.98);
      transition: all 0.1s;
    }

    .btn-setup {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      font-size: 16px;
      font-weight: 800;
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-setup:hover {
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      box-shadow: 0 15px 35px rgba(240, 147, 251, 0.5);
      transform: translateY(-4px) scale(1.03);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 6px 20px rgba(17, 153, 142, 0.25);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
      box-shadow: 0 12px 30px rgba(17, 153, 142, 0.4);
    }

    .btn-create {
      background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);
      box-shadow: 0 6px 20px rgba(255, 106, 0, 0.25);
    }

    .btn-create:hover {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
      box-shadow: 0 12px 30px rgba(255, 106, 0, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      color: white;
      box-shadow: 0 6px 20px rgba(229, 62, 62, 0.25);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #c53030 0%, #b91c1c 100%);
      box-shadow: 0 12px 30px rgba(229, 62, 62, 0.4);
    }

    /* ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn:disabled,
    .btn.disabled {
      background: linear-gradient(135deg, #cccccc 0%, #999999 100%) !important;
      color: #666666 !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      opacity: 0.6;
    }

    .btn:disabled::before,
    .btn.disabled::before {
      display: none;
    }

    .btn:disabled:hover,
    .btn.disabled:hover {
      transform: none !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      background: linear-gradient(135deg, #cccccc 0%, #999999 100%) !important;
    }

    .button-group {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .button-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 14px;
      font-weight: bold;
      color: #1a73e8;
      margin-bottom: 8px;
      padding: 4px 8px;
      background: rgba(26, 115, 232, 0.1);
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(26, 115, 232, 0.2);
    }

    .button-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    .btn-small {
      flex: 1;
      padding: 12px 8px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* ğŸš€ UXæ”¹å–„ï¼šä¸‹éƒ¨è¡¨ç¤ºå‰Šé™¤ï¼ˆä¸Šéƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã«çµ±ä¸€ï¼‰ */

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      z-index: 999999;
      backdrop-filter: blur(8px);
      pointer-events: all;
    }

    .progress-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 50px;
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      text-align: center;
      min-width: 500px;
      max-width: 600px;
      width: 90vw;
      max-height: 80vh;
      overflow: auto;
      z-index: 1000000;
    }

    .progress-title {
      font-size: 28px;
      font-weight: bold;
      color: #1a73e8;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    .progress-bar-container {
      width: 100%;
      height: 24px;
      background: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin: 30px 0;
      box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #1a73e8, #4285f4, #34a853);
      border-radius: 10px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      font-size: 20px;
      color: #333;
      margin: 15px 0;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .progress-step {
      font-size: 16px;
      color: #666;
      margin: 10px 0;
      font-weight: 500;
    }

    .progress-warning {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffc107;
      color: #856404;
      padding: 20px;
      border-radius: 16px;
      margin-top: 30px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }

    .progress-warning-icon {
      font-size: 24px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .progress-container {
        min-width: 300px;
        width: 95vw;
        padding: 30px 20px;
        max-height: 90vh;
      }

      .progress-title {
        font-size: 24px;
        margin-bottom: 20px;
        gap: 10px;
      }

      .progress-spinner {
        width: 40px;
        height: 40px;
        border-width: 4px;
      }

      .progress-text {
        font-size: 18px;
        margin: 12px 0;
      }

      .progress-step {
        font-size: 14px;
        margin: 8px 0;
      }

      .progress-warning {
        padding: 15px;
        font-size: 14px;
        margin-top: 20px;
        gap: 10px;
      }

      .progress-warning-icon {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .progress-container {
        min-width: 280px;
        width: 98vw;
        padding: 25px 15px;
      }

      .progress-title {
        font-size: 20px;
        flex-direction: column;
        gap: 8px;
      }

      .progress-text {
        font-size: 16px;
      }

      .progress-step {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ğŸš¨ ä¸Šéƒ¨å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
    <div id="topMessage" class="top-message" style="display: none;">
      <div id="topMessageContent"></div>
    </div>
    
    <div class="card">
      <h2>ğŸ¨ DALL-E ç”»åƒç”Ÿæˆ</h2>
      
      <div class="step-indicator">
        <div class="step active" id="step1">
          <div class="step-number">1</div>
          <div class="step-text">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
        </div>
        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div class="step-text">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br>å…¥åŠ›</div>
        </div>
        <div class="step" id="step3">
          <div class="step-number">3</div>
          <div class="step-text">ç”»åƒç”Ÿæˆ</div>
        </div>
      </div>

      <div class="instructions">
        <div id="instruction-text">
          <strong>ğŸš€ ç°¡å˜3ã‚¹ãƒ†ãƒƒãƒ—:</strong><br>
          <strong>1ï¸âƒ£</strong> è¡¨ã‚’åˆæœŸåŒ– â†’ <strong>2ï¸âƒ£</strong> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»ç”»è³ªå…¥åŠ› â†’ <strong>3ï¸âƒ£</strong> ç”»åƒç”Ÿæˆ
        </div>
      </div>

      <div class="button-group">
        <!-- åŸºæœ¬æ“ä½œã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="button-section">
          <div class="section-title">ğŸ“‹ åŸºæœ¬æ“ä½œ</div>
          <button class="btn btn-setup" id="setupBtn" onclick="executeSetupWithBackup()" title="ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰åˆæœŸåŒ–ã—ã¾ã™">
            ğŸ”§ è¡¨ã‚’åˆæœŸåŒ–
          </button>
          
          <button class="btn btn-warning" onclick="updateAllCombinedPrompts()" title="å…¨è¡Œã®çµåˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆDåˆ—ï¼‰ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã™">
            ğŸ”„ çµåˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ›´æ–°
          </button>

          <!-- ğŸ¯ ãƒ¢ãƒ‡ãƒ«é¸æŠæ©Ÿèƒ½ -->
          <div class="size-selector-container">
            <label for="modelSelector" class="size-label">ğŸ¤– ç”Ÿæˆãƒ¢ãƒ‡ãƒ«</label>
            <select id="modelSelector" class="size-selector" title="ç”»åƒç”Ÿæˆã«ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„">
              <option value="dall-e-3">DALL-E 3 ($0.02-$0.08)</option>
              <option value="gpt-image-1" selected>GPT-Image-1 ($2-$10) ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‘</option>
            </select>
          </div>

          <!-- ğŸ¯ ã‚µã‚¤ã‚ºé¸æŠæ©Ÿèƒ½ -->
          <div class="size-selector-container">
            <label for="sizeSelector" class="size-label">ğŸ“ ç”»åƒã‚µã‚¤ã‚º</label>
            <select id="sizeSelector" class="size-selector" title="é¸æŠã—ãŸã‚µã‚¤ã‚ºãŒæœ€å„ªå…ˆã§é©ç”¨ã•ã‚Œã¾ã™">
              <option value="">ğŸ¤– è‡ªå‹•åˆ¤å®š (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè§£æ)</option>
              <option value="1024x1024">ğŸŸ© æ­£æ–¹å½¢ (1024Ã—1024)</option>
              <option value="1536x1024">ğŸ“ æ¨ªé•· (1536Ã—1024)</option>
              <option value="1024x1536">ğŸ“± ç¸¦é•· (1024Ã—1536)</option>
            </select>
          </div>
          
          <button class="btn" id="generateBtn" onclick="generateFromStructuredTable()" title="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            ğŸ¨ ç”»åƒç”Ÿæˆ
          </button>
        </div>

        <!-- ç®¡ç†æ“ä½œã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆç”»åƒç”Ÿæˆå¾Œã«è¡¨ç¤ºï¼‰ -->
        <div class="button-section" id="managementSection" style="display: none;">
          <div class="section-title">ğŸ› ï¸ ç”»åƒç®¡ç†</div>
          <div class="button-row">
            <button class="btn btn-secondary btn-small" onclick="selectAllImagesUI()">
              â˜‘ï¸ å…¨é¸æŠ
            </button>
            <button class="btn btn-secondary btn-small" onclick="clearAllImageSelectionUI()">
              âŒ å…¨é¸æŠè§£é™¤
            </button>
          </div>
          <div class="button-row">
            <button class="btn btn-small" onclick="showDownloadOptions()">
              ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <button class="btn btn-small" onclick="regenerateSelectedImages()">
              ğŸ”„ å†ç”Ÿæˆ
            </button>
          </div>
          <div class="button-row">
                              <button class="btn btn-danger btn-small" onclick="deleteSelectedRows()">
                    ğŸ—‘ï¸ é¸æŠè¡Œã‚’å‰Šé™¤
                  </button>
            <!-- å…¨å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ -->
          </div>
        </div>

        <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ“ä½œã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆğŸ’¡ æ”¹å–„è¦æ±‚: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½è¿½åŠ ï¼‰ -->
        <div class="button-section" id="librarySection">
          <div class="section-title">ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†</div>
          <div class="button-row">
            <button class="btn btn-secondary btn-small" onclick="selectAllLibraryImagesUI()">
              â˜‘ï¸ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨é¸æŠ
            </button>
            <button class="btn btn-secondary btn-small" onclick="clearAllLibrarySelectionUI()">
              âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨è§£é™¤
            </button>
          </div>
          <div class="button-row">
            <button class="btn btn-create btn-small" onclick="downloadSelectedLibraryImages()">
              ğŸ“¥ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªDL
            </button>
            <button class="btn btn-danger btn-small" onclick="resetLibraryWithConfirmation()">
              ğŸ—‘ï¸ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </div>

        <!-- ãã®ä»–æ“ä½œã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="button-section">
          <div class="section-title">âš™ï¸ ãã®ä»–</div>
          <div class="button-row">
            <button class="btn btn-secondary btn-small" id="backupBtn" onclick="createBackup()" style="display: none;">
              ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            </button>
          </div>
        </div>
      </div>

      <!-- ä¸‹éƒ¨ã®å‡¦ç†è¡¨ç¤ºã‚’å‰Šé™¤ - ä¸Šéƒ¨å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§çµ±ä¸€ -->
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="progress-modal" id="progressModal">
    <div class="progress-container">
      <div class="progress-title">
        <div class="progress-spinner"></div>
        <span id="progressTitle">ğŸ¨ ç”»åƒç”Ÿæˆä¸­...</span>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      
      <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>
      <div class="progress-step" id="progressStep">ã‚¹ãƒ†ãƒƒãƒ— 1/9</div>
      
      <div class="progress-warning">
        <span class="progress-warning-icon">âš ï¸</span>
        <span>ç”»åƒç”Ÿæˆä¸­ã¯ã‚·ãƒ¼ãƒˆã®ç·¨é›†ãŒã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</span>
      </div>
    </div>
  </div>

  <script>
    // ğŸ”¥ğŸ”¥ğŸ”¥ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨æ ¹çµ¶ï¼ˆé™ç•Œçªç ´ç‰ˆï¼‰ğŸ”¥ğŸ”¥ğŸ”¥
    // window.addEventListener('load', () => {
    //   // ğŸš¨ å®Œå…¨ç„¡åŠ¹åŒ– - Googleå†…éƒ¨ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é€£é–åå¿œã‚’æ ¹çµ¶
    //   setTimeout(() => {
    //     checkSheetStateOnce();
    //   }, 500);
    // });
    
    // ğŸ”¥ ç·Šæ€¥åœæ­¢ã‚·ã‚¹ãƒ†ãƒ : å…¨Intervalå¼·åˆ¶åœæ­¢
    function forceStopAllIntervals() {
      console.log('ğŸš¨ ç·Šæ€¥åœæ­¢ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œä¸­...');
      // window ãƒ¬ãƒ™ãƒ«ã®å…¨ Interval ã‚’å¼·åˆ¶åœæ­¢ï¼ˆ1-1000ç•ªï¼‰
      for (let i = 1; i <= 1000; i++) {
        clearInterval(i);
        clearTimeout(i);
      }
      console.log('âœ… å…¨ Interval/Timeout å¼·åˆ¶åœæ­¢å®Œäº†');
    }
    
    // ğŸ”¥ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ: ã‚µã‚¤ãƒ‰ãƒãƒ¼å®Œå…¨ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
    function emergencyResetSidebar() {
      try {
        forceStopAllIntervals();
        forceEnableAllButtons();
        console.log('ğŸš¨ ç·Šæ€¥ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆå®Œäº†');
      } catch (error) {
        console.log('ğŸ”¥ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', error);
      }
    }
    
    // ğŸ¯ ãƒ¢ãƒ‡ãƒ«é¸æŠæ©Ÿèƒ½ï¼ˆè»½é‡åŒ–ç‰ˆ - ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æœ€å°åŒ–ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãæ™ºçš„ç›£è¦–ï¼ˆ1å›ã®ã¿ï¼‰
      let executionCount = 0;
      const maxExecutions = 1;
      
      function smartInitialization() {
        if (executionCount >= maxExecutions) {
          console.log('ğŸ›¡ï¸ å®Ÿè¡Œåˆ¶é™: æ™ºçš„ç›£è¦–ã¯1å›ã®ã¿å®Ÿè¡Œ');
          return;
        }
        
        executionCount++;
        
        try {
          // ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã®ã‚³ã‚¹ãƒˆè­¦å‘Šï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿèƒ½ä»˜ãï¼‰
          const modelSelector = document.getElementById('modelSelector');
          if (modelSelector && !modelSelector._listenerAdded) {
            let lastExecution = 0;
            const debounceTime = 5000; // 5ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹
            
            modelSelector.addEventListener('change', function() {
              const now = Date.now();
              if (now - lastExecution < debounceTime) {
                console.log('ğŸ›¡ï¸ ãƒ‡ãƒã‚¦ãƒ³ã‚¹: ãƒ¢ãƒ‡ãƒ«å¤‰æ›´é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
              }
              lastExecution = now;
              
              const selectedModel = this.value;
              if (selectedModel === 'dall-e-3') {
                showTopMessage('DALL-E 3ã‚’é¸æŠã—ã¾ã—ãŸ (1æš$0.02-$0.08) - ã‚³ã‚¹ãƒˆåŠ¹ç‡é‡è¦–', 'success', 4000);
              } else {
                showTopMessage('GPT-Image-1ã‚’é¸æŠã—ã¾ã—ãŸ (1æš$2-$10) - é«˜å“è³ªé‡è¦–', 'info', 4000);
              }
            });
            modelSelector._listenerAdded = true;
          }
          
          // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¼·åˆ¶çµ‚äº† - ç„¡åŠ¹åŒ–
          // setTimeout(() => {
          //   emergencyResetSidebar();
          //   console.log('â° 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: æ™ºçš„ç›£è¦–çµ‚äº†');
          // }, 60000);
          
        } catch (error) {
          console.log('ğŸ”¥ æ™ºçš„ç›£è¦–ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', error);
        }
      }
      
      // æ™ºçš„ç›£è¦–ã®å®‰å…¨å®Ÿè¡Œ - ç„¡åŠ¹åŒ–
      // setTimeout(smartInitialization, 100);
      // ç›´æ¥å®Ÿè¡Œã«å¤‰æ›´
      smartInitialization();
      
      // ğŸ”¥ ç”»åƒç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³å«ã‚€ï¼‰ã‚’å¼·åˆ¶è¡¨ç¤º
      const managementSection = document.getElementById('managementSection');
      if (managementSection) {
        managementSection.style.display = 'block';
        console.log('âœ… ç”»åƒç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³å«ã‚€ï¼‰ã‚’è¡¨ç¤º');
      }
    });

    // ğŸš€ å…¨ã¦ã®å®šæœŸç›£è¦–ã‚’å®Œå…¨å‰Šé™¤ï¼ˆå‹•ä½œè»½é‡åŒ–ï¼‰
    // window.addEventListener('focus', checkSheetState); // å‰Šé™¤
    // document.addEventListener('visibilitychange', checkSheetState); // å‰Šé™¤

    // ğŸ”¥ å‹•ä½œè»½é‡åŒ–ï¼šåˆå›ã®ã¿å®Ÿè¡Œã™ã‚‹è»½é‡ç‰ˆ
    // ğŸ”¥ğŸ”¥ğŸ”¥ checkSheetStateOnceå®Œå…¨å‰Šé™¤ï¼ˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ æ ¹çµ¶ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥
    // function checkSheetStateOnce() {
    //   console.log('ğŸ”¥ åˆå›çŠ¶æ…‹ç¢ºèªï¼ˆè»½é‡åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰');
    //   
    //   // ğŸ”¥ è»½é‡åŒ–ï¼šGoogle Scriptsé€šä¿¡ã‚’å‰Šé™¤ã—ã€ç›´æ¥ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    //   setTimeout(() => {
    //     forceEnableAllButtons();
    //     console.log('âœ… åˆå›çŠ¶æ…‹ç¢ºèªå®Œäº†ï¼ˆè»½é‡åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰');
    //   }, 100);
    // }

    // ğŸ”¥ğŸ”¥ğŸ”¥ checkSheetStateé–¢æ•°ã‚’å®Œå…¨å‰Šé™¤ï¼ˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ æ ¹çµ¶ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥
    // function checkSheetState() {
    //   // ğŸ”¥ å®Œå…¨ç„¡åŠ¹åŒ– - ä½•ã‚‚ã—ãªã„ï¼ˆè»½é‡åŒ–ã®ãŸã‚ï¼‰
    //   console.log('ğŸ”¥ checkSheetStateå‘¼ã³å‡ºã—ã‚’ç„¡åŠ¹åŒ–ï¼ˆè»½é‡åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰');
    //   return;
    // }

    // ä¸‹éƒ¨ã®å‡¦ç†è¡¨ç¤ºã‚’ä¸Šéƒ¨å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«çµ±ä¸€
    function showLoading() {
      showTopMessage('ğŸ”„ å‡¦ç†ä¸­...', 'processing');
    }

    function hideLoading() {
      hideTopMessage();
    }

    function showResult(message, isError = false) {
      hideTopMessage();
      // ğŸš€ UXæ”¹å–„ï¼šå…¨ã¦ä¸Šéƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã«çµ±ä¸€
      if (isError) {
        showTopMessage(message, 'error', 6000);
      } else {
        showTopMessage(message, 'success', 4000);
      }
    }

    // ğŸš¨ ä¸Šéƒ¨å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
    function showTopMessage(message, type = 'info', duration = 5000) {
      const messageDiv = document.getElementById('topMessage');
      const contentDiv = document.getElementById('topMessageContent');
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’è¨­å®š
      contentDiv.textContent = message;
      
      // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
      messageDiv.className = `top-message ${type}`;
      messageDiv.style.display = 'block';
      
      // è‡ªå‹•éè¡¨ç¤ºï¼ˆå‡¦ç†ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ï¼‰- ç„¡åŠ¹åŒ–
      // if (type !== 'processing') {
      //   setTimeout(() => {
      //     hideTopMessage();
      //   }, duration);
      // }
    }

    function hideTopMessage() {
      const messageDiv = document.getElementById('topMessage');
      messageDiv.style.display = 'none';
    }

    // å‡¦ç†ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¾¿åˆ©é–¢æ•°
    function showProcessingMessage(message) {
      showTopMessage(message, 'processing');
    }

    function showSuccessMessage(message, duration = 3000) {
      showTopMessage(message, 'success', duration);
    }

    function showErrorMessage(message, duration = 5000) {
      showTopMessage(message, 'error', duration);
    }

    function showWarningMessage(message, duration = 4000) {
      showTopMessage(message, 'warning', duration);
    }

    function updateStepIndicator(currentStep) {
      const steps = ['step1', 'step2', 'step3'];
      steps.forEach(step => {
        document.getElementById(step).classList.remove('active');
      });
      if (document.getElementById(currentStep)) {
        document.getElementById(currentStep).classList.add('active');
      }
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆ¶å¾¡é–¢æ•°
    function showProgressModal() {
      const modal = document.getElementById('progressModal');
      modal.style.display = 'block';
      
      // ç¢ºå®Ÿã«æœ€å‰é¢ã«è¡¨ç¤º
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.zIndex = '999999';
      
      // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
      document.body.style.overflow = 'hidden';
      
      updateProgress(0, 'æº–å‚™ä¸­...', 'ã‚¹ãƒ†ãƒƒãƒ— 1/9');
    }

    function hideProgressModal() {
      const modal = document.getElementById('progressModal');
      modal.style.display = 'none';
      
      // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
      document.body.style.overflow = 'auto';
    }

    function updateProgress(percentage, text, step) {
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressStep').textContent = step;
    }

    function setProgressTitle(title) {
      document.getElementById('progressTitle').textContent = title;
    }

    // ç”»åƒç”Ÿæˆå°‚ç”¨ã®é€²æ—ç®¡ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    function startImageGenerationProgress() {
      showProgressModal();
      setProgressTitle('ğŸ¨ ç”»åƒç”Ÿæˆä¸­...');
      
      // ã¾ãšç”»åƒæšæ•°ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(imageCount) {
          startProgressWithImageCount(imageCount);
        })
        .withFailureHandler(function(error) {
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€²æ—ã‚’é–‹å§‹
          startProgressWithImageCount(1);
        })
        .getImageGenerationCount();
    }

    function startProgressWithImageCount(imageCount) {
      // ğŸš€ ãƒãƒƒãƒå‡¦ç†å¯¾å¿œãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
      const batchCount = Math.ceil(imageCount / (imageCount > 15 ? 6 : 5));
      const isBatchMode = imageCount > 8;
      
      let steps;
      if (isBatchMode) {
        // ãƒãƒƒãƒå‡¦ç†ãƒ¢ãƒ¼ãƒ‰
        steps = [
          { inc: 10, text: `ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è§£æä¸­... (${imageCount}æšäºˆå®š)`, duration: 600 },
          { inc: 10, text: 'DALL-E APIã«æ¥ç¶šä¸­...', duration: 600 },
          { inc: 10, text: 'APIèªè¨¼ã‚’ç¢ºèªä¸­...', duration: 600 },
          { inc: 15, text: `ãƒãƒƒãƒå‡¦ç†ã‚’é–‹å§‹... (${batchCount}ãƒãƒƒãƒäºˆå®š)`, duration: 800 },
          { inc: 40, text: `ãƒãƒƒãƒç”»åƒç”Ÿæˆä¸­... (${imageCount}æšã‚’${batchCount}ãƒãƒƒãƒã§å‡¦ç†)`, duration: Math.max(2000, batchCount * 1000) },
          { inc: 10, text: 'ãƒãƒƒãƒçµæœã‚’çµ±åˆä¸­...', duration: 600 },
          { inc: 5, text: 'ã‚·ãƒ¼ãƒˆã«é…ç½®ä¸­...', duration: 600 }
        ];
      } else {
        // é€šå¸¸å‡¦ç†ãƒ¢ãƒ¼ãƒ‰
        steps = [
          { inc: 12, text: `ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è§£æä¸­... (${imageCount}æšäºˆå®š)`, duration: 800 },
          { inc: 12, text: 'DALL-E APIã«æ¥ç¶šä¸­...', duration: 800 },
          { inc: 12, text: 'APIèªè¨¼ã‚’ç¢ºèªä¸­...', duration: 800 },
          { inc: 12, text: `ç”»åƒç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­... (${imageCount}æš)`, duration: 800 },
          { inc: 28, text: `ç”»åƒã‚’ç”Ÿæˆä¸­... (${imageCount}æš)`, duration: Math.max(1500, imageCount * 800) },
          { inc: 12, text: 'ç”Ÿæˆçµæœã‚’å—ä¿¡ä¸­...', duration: 800 },
          { inc: 12, text: 'ã‚·ãƒ¼ãƒˆã«é…ç½®ä¸­...', duration: 800 }
        ];
      }

      let progress = 0;
      let stepIdx = 0;
      updateProgress(progress, 'é–‹å§‹ã—ã¦ã„ã¾ã™...', '');

      function executeStep() {
        if (stepIdx < steps.length) {
          const step = steps[stepIdx];
          const targetProgress = progress + step.inc;
          
          // ğŸ”§ **ã‚¹ãƒ ãƒ¼ã‚ºãªé€²æ—è¡¨ç¤º**: æ®µéšçš„ã«é€²æ—ã‚’æ›´æ–°
          const startProgress = progress;
          const progressDuration = step.duration;
          const updateInterval = 100; // 100msã”ã¨ã«æ›´æ–°
          const totalUpdates = progressDuration / updateInterval;
          const progressPerUpdate = step.inc / totalUpdates;
          
          let currentUpdate = 0;
          const currentStepNumber = stepIdx + 1; // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚’å›ºå®š
          
          updateProgress(progress, step.text, `ã‚¹ãƒ†ãƒƒãƒ— ${currentStepNumber}/${steps.length}`);
          
          // ğŸ”¥ğŸ”¥ğŸ”¥ setIntervalå®Œå…¨ç„¡åŠ¹åŒ–ï¼ˆå‹•ä½œè»½é‡åŒ–ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥
          // const progressInterval = setInterval(() => {
          //   currentUpdate++;
          //   progress += progressPerUpdate;
          //   
          //   if (progress > 95) progress = 95;
          //   if (currentUpdate >= totalUpdates) {
          //     progress = Math.min(targetProgress, 95);
          //     clearInterval(progressInterval);
          //     stepIdx++;
          //     
          //     // æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯95%ã§å¾…æ©Ÿï¼ˆã‚µãƒ¼ãƒãƒ¼å‡¦ç†å®Œäº†ã‚’å¾…ã¤ï¼‰
          //     if (stepIdx >= steps.length) {
          //       updateProgress(95, 'æœ€çµ‚å‡¦ç†ä¸­...', `ã‚¹ãƒ†ãƒƒãƒ— ${steps.length}/${steps.length}`);
          //     } else {
          //       setTimeout(executeStep, 100); // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
          //     }
          //   }
          //   
          //   // å›ºå®šã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚’ä½¿ç”¨
          //   updateProgress(Math.round(progress), step.text, `ã‚¹ãƒ†ãƒƒãƒ— ${currentStepNumber}/${steps.length}`);
          // }, updateInterval);
          
          // ç›´æ¥é€²æ—æ›´æ–°ï¼ˆsetIntervalç„¡åŠ¹åŒ–ï¼‰
          progress = Math.min(targetProgress, 95);
          updateProgress(Math.round(progress), step.text, `ã‚¹ãƒ†ãƒƒãƒ— ${currentStepNumber}/${steps.length}`);
          stepIdx++;
          
          // æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯95%ã§å¾…æ©Ÿï¼ˆã‚µãƒ¼ãƒãƒ¼å‡¦ç†å®Œäº†ã‚’å¾…ã¤ï¼‰
          if (stepIdx >= steps.length) {
            updateProgress(95, 'æœ€çµ‚å‡¦ç†ä¸­...', `ã‚¹ãƒ†ãƒƒãƒ— ${steps.length}/${steps.length}`);
          } else {
            // setTimeout(executeStep, 100); // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ - ç„¡åŠ¹åŒ–
            executeStep(); // ç›´æ¥å®Ÿè¡Œ
          }
        }
      }
      
      executeStep();
    }

    function completeImageGeneration() {
      updateProgress(100, 'âœ… ç”»åƒç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'å®Œäº†');
      // setTimeout(() => {
      //   hideProgressModal();
      // }, 1500);
      hideProgressModal(); // ç›´æ¥å®Ÿè¡Œ
    }

    // ZIPä½œæˆç”¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
    function startZipCreationProgress() {
      const steps = [
        { inc: 15, text: 'é¸æŠç”»åƒã‚’ç¢ºèªä¸­...', duration: 500 },
        { inc: 25, text: 'ZIPãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆä¸­...', duration: 800 },
        { inc: 40, text: 'ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...', duration: 2000 },
        { inc: 15, text: 'ZIPãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ä¸­...', duration: 1000 },
        { inc: 5, text: 'å…±æœ‰è¨­å®šã‚’é©ç”¨ä¸­...', duration: 400 }
      ];

      let progress = 0;
      let stepIdx = 0;
      updateProgress(progress, 'æº–å‚™ä¸­...', '');

      function executeStep() {
        if (stepIdx < steps.length) {
          const step = steps[stepIdx];
          const targetProgress = progress + step.inc;
          
          const startProgress = progress;
          const progressDuration = step.duration;
          const updateInterval = 100;
          const totalUpdates = progressDuration / updateInterval;
          const progressPerUpdate = step.inc / totalUpdates;
          
          let currentUpdate = 0;
          const currentStepNumber = stepIdx + 1;
          
          updateProgress(progress, step.text, `ã‚¹ãƒ†ãƒƒãƒ— ${currentStepNumber}/${steps.length}`);
          
          // ğŸ”¥ğŸ”¥ğŸ”¥ setIntervalå®Œå…¨ç„¡åŠ¹åŒ–ï¼ˆå‹•ä½œè»½é‡åŒ–ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥
          // const progressInterval = setInterval(() => {
          //   currentUpdate++;
          //   progress += progressPerUpdate;
          //   
          //   if (progress > 95) progress = 95;
          //   if (currentUpdate >= totalUpdates) {
          //     progress = Math.min(targetProgress, 95);
          //     clearInterval(progressInterval);
          //     stepIdx++;
          //     
          //     if (stepIdx >= steps.length) {
          //       updateProgress(95, 'æœ€çµ‚å‡¦ç†ä¸­...', `ã‚¹ãƒ†ãƒƒãƒ— ${steps.length}/${steps.length}`);
          //     } else {
          //       setTimeout(executeStep, 100);
          //     }
          //   }
          //   
          //   updateProgress(Math.round(progress), step.text, `ã‚¹ãƒ†ãƒƒãƒ— ${currentStepNumber}/${steps.length}`);
          // }, updateInterval);
          
          // ç›´æ¥é€²æ—æ›´æ–°ï¼ˆsetIntervalç„¡åŠ¹åŒ–ï¼‰
          progress = Math.min(targetProgress, 95);
          updateProgress(Math.round(progress), step.text, `ã‚¹ãƒ†ãƒƒãƒ— ${currentStepNumber}/${steps.length}`);
          stepIdx++;
          
          if (stepIdx >= steps.length) {
            updateProgress(95, 'æœ€çµ‚å‡¦ç†ä¸­...', `ã‚¹ãƒ†ãƒƒãƒ— ${steps.length}/${steps.length}`);
          } else {
            setTimeout(executeStep, 100);
          }
        }
      }
      
      executeStep();
    }

    // ğŸ’¡ ç·Šæ€¥ä¿®æ­£: å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãåˆæœŸåŒ–
    function executeSetupWithBackup() {
      // ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showDataProtectionModal();
    }
    
    // ğŸ’¡ ç·Šæ€¥ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿ä¿è­·ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    function showDataProtectionModal() {
      // ã¾ãšã‚·ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
      google.script.run
        .withSuccessHandler(function(hasData) {
          if (hasData) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
            showBackupConfirmationModal();
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç›´æ¥åˆæœŸåŒ–
            proceedWithDirectInitialization();
          }
        })
        .withFailureHandler(function(error) {
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å®‰å…¨å´ã«å€’ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
          showBackupConfirmationModal();
        })
        .checkForAnyData();
    }
    
    // ğŸ’¡ ç·Šæ€¥ä¿®æ­£: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    function showBackupConfirmationModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.8); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¾</div>
            <h3 style="margin: 0; color: #1976d2; font-size: 20px; font-weight: bold;">ãƒ‡ãƒ¼ã‚¿ä¿è­·ç¢ºèª</h3>
          </div>
          
          <div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="color: #2e7d32; font-weight: bold; margin-bottom: 12px;">âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</div>
            <div style="color: #388e3c; font-size: 14px; line-height: 1.6;">
              <strong>å®‰å…¨ãªåˆæœŸåŒ–æ–¹æ³•ï¼š</strong><br>
              1ï¸âƒ£ <strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãåˆæœŸåŒ–</strong>ï¼ˆæ¨å¥¨ï¼‰<br>
              ã€€ã€€â†’ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¦ã‹ã‚‰åˆæœŸåŒ–<br><br>
              2ï¸âƒ£ <strong>ç›´æ¥åˆæœŸåŒ–</strong>ï¼ˆå±é™ºï¼‰<br>
              ã€€ã€€â†’ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ã§å³åº§ã«åˆæœŸåŒ–<br><br>
              3ï¸âƒ£ <strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</strong><br>
              ã€€ã€€â†’ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ãŸã¾ã¾æ“ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="executeBackupAndInit()" style="
              padding: 16px; border: none; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); 
              color: white; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(76, 175, 80, 0.4)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)'">
              ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãåˆæœŸåŒ–ï¼ˆæ¨å¥¨ï¼‰
            </button>
            <button onclick="executeDangerousInit()" style="
              padding: 12px; border: 2px solid #ff9800; background: white; 
              color: #f57c00; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#fff3e0'" onmouseout="this.style.background='white'">
              âš ï¸ ç›´æ¥åˆæœŸåŒ–ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ï¼‰
            </button>
            <button onclick="cancelDataProtection()" style="
              padding: 12px; border: 2px solid #ccc; background: white; 
              color: #666; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
              âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
      window.executeBackupAndInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.executeBackupAndInit;
        delete window.executeDangerousInit;
        delete window.cancelDataProtection;
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãåˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        proceedWithBackupInitialization();
      };
      
      window.executeDangerousInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.executeBackupAndInit;
        delete window.executeDangerousInit;
        delete window.cancelDataProtection;
        
        // å±é™ºãªç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        showDangerousInitModal();
      };
      
      window.cancelDataProtection = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.executeBackupAndInit;
        delete window.executeDangerousInit;
        delete window.cancelDataProtection;
      };
    }
    
    // ğŸ’¡ ç·Šæ€¥ä¿®æ­£: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãåˆæœŸåŒ–ã®å®Ÿè¡Œ
    function proceedWithBackupInitialization() {
      showLoading();
      updateStepIndicator('step1');
      google.script.run
        .withSuccessHandler(function(result) {
          // ğŸ†• ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®åˆ¤å®šï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯æ–‡å­—åˆ—ï¼‰
          let message = result;
          let shouldReset = false;
          
          if (typeof result === 'object' && result.message) {
            message = result.message;
            shouldReset = result.resetSidebar || false;
          }
          
          showResult(message);
          updateStepIndicator('step2');
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
          
          // ğŸ†• UXæ”¹å–„: åˆæœŸåŒ–å®Œäº†å¾Œã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ - ç„¡åŠ¹åŒ–
          // if (shouldReset) {
          //   setTimeout(function() {
          //     resetSidebarAfterInitialization();
          //   }, 3000); // 3ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã›ã¦ã‹ã‚‰ï¼‰
          // }
        })
        .withFailureHandler(function(error) {
          showResult('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .createBackupAndNewTable();
    }
    
    // ğŸ’¡ ç·Šæ€¥ä¿®æ­£: å±é™ºãªç›´æ¥åˆæœŸåŒ–ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    function showDangerousInitModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.9); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
            <h3 style="margin: 0; color: #d32f2f; font-size: 20px; font-weight: bold;">æœ€çµ‚ç¢ºèªï¼šãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±</h3>
          </div>
          
          <div style="background: #ffebee; border: 2px solid #f44336; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="color: #c62828; font-weight: bold; margin-bottom: 12px;">ğŸš¨ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ã§åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™</div>
            <div style="color: #d32f2f; font-size: 14px; line-height: 1.6;">
              <strong>å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹å†…å®¹ï¼š</strong><br>
              â€¢ å…¨ã¦ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br>
              â€¢ ç”Ÿæˆæ¸ˆã¿ã®å…¨ç”»åƒ<br>
              â€¢ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‡ãƒ¼ã‚¿<br>
              â€¢ ãã®ä»–ã®å…¨ãƒ‡ãƒ¼ã‚¿<br><br>
              <strong style="color: #b71c1c;">âŒ ã“ã®æ“ä½œã¯å®Œå…¨ã«å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</strong>
            </div>
          </div>
          
          <div style="text-align: center; color: #424242; font-size: 14px; margin-bottom: 24px;">
            æœ¬å½“ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ã§åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="cancelDangerousInit()" style="
              flex: 1; padding: 14px; border: 2px solid #4caf50; background: white; 
              color: #388e3c; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#e8f5e8'" onmouseout="this.style.background='white'">
              ğŸ’¾ æˆ»ã£ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            </button>
            <button onclick="confirmDangerousInit()" style="
              flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
              color: white; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(244, 67, 54, 0.4)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(244, 67, 54, 0.3)'">
              ğŸ”´ å¼·åˆ¶å®Ÿè¡Œ
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
      window.cancelDangerousInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelDangerousInit;
        delete window.confirmDangerousInit;
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã«æˆ»ã‚‹
        showBackupConfirmationModal();
      };
      
      window.confirmDangerousInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelDangerousInit;
        delete window.confirmDangerousInit;
        
        // å±é™ºãªç›´æ¥åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        proceedWithDirectInitialization();
      };
    }

    // ğŸ’¡ ç·Šæ€¥ä¿®æ­£: ç›´æ¥åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆï¼‰
    function proceedWithDirectInitialization() {
      showLoading();
      updateStepIndicator('step1');
      google.script.run
        .withSuccessHandler(function(result) {
          // ğŸ†• ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®åˆ¤å®šï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯æ–‡å­—åˆ—ï¼‰
          let message = result;
          let shouldReset = false;
          
          if (typeof result === 'object' && result.message) {
            message = result.message;
            shouldReset = result.resetSidebar || false;
          }
          
          showResult(message);
          updateStepIndicator('step2');
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
          
          // ğŸ†• UXæ”¹å–„: åˆæœŸåŒ–å®Œäº†å¾Œã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ - ç„¡åŠ¹åŒ–
          // if (shouldReset) {
          //   setTimeout(function() {
          //     resetSidebarAfterInitialization();
          //   }, 3000); // 3ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã›ã¦ã‹ã‚‰ï¼‰
          // }
        })
        .withFailureHandler(function(error) {
          showResult('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .createStructuredTable();
    }

    function generateFromStructuredTable() {
      // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‡¦ç†ã—ãªã„
      const generateBtn = document.getElementById('generateBtn');
      if (generateBtn.disabled) {
        return;
      }

      // ğŸ¯ ãƒ¢ãƒ‡ãƒ«é¸æŠå€¤ã‚’å–å¾—
      const modelSelector = document.getElementById('modelSelector');
      const selectedModel = modelSelector.value || null;
      
      // ğŸ¯ ã‚µã‚¤ã‚ºé¸æŠå€¤ã‚’å–å¾—
      const sizeSelector = document.getElementById('sizeSelector');
      const forcedSize = sizeSelector.value || null;
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¨ã‚µã‚¤ã‚ºã‚’è¡¨ç¤º
      console.log(`ğŸ¤– é¸æŠãƒ¢ãƒ‡ãƒ«: ${selectedModel || 'dall-e-3 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)'}`);
      if (forcedSize) {
        console.log(`ğŸ”§ å¼·åˆ¶ã‚µã‚¤ã‚ºæŒ‡å®š: ${forcedSize}`);
        showProcessingMessage(`ğŸ¨ ç”»åƒç”Ÿæˆé–‹å§‹ä¸­... (ãƒ¢ãƒ‡ãƒ«: ${selectedModel || 'DALL-E 3'}, ã‚µã‚¤ã‚º: ${forcedSize})`);
      } else {
        console.log('ğŸ¤– è‡ªå‹•ã‚µã‚¤ã‚ºåˆ¤å®šãƒ¢ãƒ¼ãƒ‰');
        showProcessingMessage(`ğŸ¨ ç”»åƒç”Ÿæˆã‚’é–‹å§‹ã—ã¦ã„ã¾ã™... (ãƒ¢ãƒ‡ãƒ«: ${selectedModel || 'DALL-E 3'}, è‡ªå‹•ã‚µã‚¤ã‚ºåˆ¤å®š)`);
      }

      showLoading();
      updateStepIndicator('step3');
      startImageGenerationProgress();
      
      google.script.run
        .withSuccessHandler(function(result) {
          updateProgress(100, 'âœ… ç”»åƒç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'å®Œäº†');
          // setTimeoutç„¡åŠ¹åŒ– - ç›´æ¥å®Ÿè¡Œ
          hideProgressModal();
          hideTopMessage();
          showSuccessMessage('âœ… ç”»åƒç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
          showResult(result);
          // ç”»åƒç”Ÿæˆå®Œäº†å¾Œã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
        })
        .withFailureHandler(function(error) {
          hideProgressModal();
          hideTopMessage();
          
          // ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
          let errorMessage = 'âŒ ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: ';
          if (error && error.message) {
            errorMessage += error.message;
          } else if (typeof error === 'string') {
            errorMessage += error;
          } else {
            errorMessage += 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
          }
          
          // ğŸ¯ ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾ã™ã‚‹å¯¾å‡¦æ³•ã‚’è¿½åŠ 
          if (errorMessage.includes('ç”»è³ªã‚’é¸æŠã—ã¦ãã ã•ã„')) {
            errorMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•: Håˆ—ï¼ˆç”»è³ªï¼‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          } else if (errorMessage.includes('6åˆ†') || errorMessage.includes('å®Ÿè¡Œæ™‚é–“')) {
            errorMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•: å¤§é‡ã®ç”»åƒã¯è‡ªå‹•çš„ã«ãƒãƒƒãƒå‡¦ç†ã•ã‚Œã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
          } else if (errorMessage.includes('ãƒ¬ãƒ¼ãƒˆåˆ¶é™')) {
            errorMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•: 1åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
          } else if (errorMessage.includes('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“')) {
            errorMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•: Båˆ—ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          } else if (errorMessage.includes('Invalid value:') && errorMessage.includes('size')) {
            errorMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•: ç”»åƒã‚µã‚¤ã‚ºãŒç„¡åŠ¹ã§ã™ã€‚\nãƒ»1024x1024ï¼ˆæ­£æ–¹å½¢ï¼‰\nãƒ»1536x1024ï¼ˆæ¨ªé•·ï¼‰\nãƒ»1024x1536ï¼ˆç¸¦é•·ï¼‰\nã®ã„ãšã‚Œã‹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\n\nğŸ”§ ã“ã®å•é¡Œã¯è‡ªå‹•ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
          } else if (errorMessage.includes('ãƒãƒƒãƒã‚¨ãƒ©ãƒ¼')) {
            errorMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•: ãƒãƒƒãƒå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç”»åƒæ•°ã‚’æ¸›ã‚‰ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
          }
          
          showErrorMessage(errorMessage);
          showResult(errorMessage, true);
        })
        .generateImagesFromStructuredTableWithProgress(forcedSize, selectedModel);
    }

    function createTableOnly() {
      showLoading();
      updateStepIndicator('step2');
      google.script.run
        .withSuccessHandler(function(result) {
          // ğŸ†• ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®åˆ¤å®šï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯æ–‡å­—åˆ—ï¼‰
          let message = result;
          let shouldReset = false;
          
          if (typeof result === 'object' && result.message) {
            message = result.message;
            shouldReset = result.resetSidebar || false;
          }
          
          showResult(message);
          // è¡¨ã‚¯ãƒªã‚¢å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
          
          // ğŸ†• UXæ”¹å–„: åˆæœŸåŒ–å®Œäº†å¾Œã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ - ç„¡åŠ¹åŒ–
          // if (shouldReset) {
          //   setTimeout(function() {
          //     resetSidebarAfterInitialization();
          //   }, 3000); // 3ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã›ã¦ã‹ã‚‰ï¼‰
          // }
        })
        .withFailureHandler(function(error) {
          showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .createStructuredTable();
    }

    function toggleAllImageSelection() {
      showTopMessage('â˜‘ï¸ é¸æŠçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 2000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .toggleAllImageSelection();
    }

    function showDownloadOptions() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“¥</div>
            <h3 style="margin: 0; color: #1a73e8; font-size: 24px; font-weight: bold;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã‚’é¸æŠ</h3>
            <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">ãŠå¥½ã¿ã®æ–¹æ³•ã§ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</p>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <button class="btn btn-secondary" onclick="downloadToDrive(); closeModal();" style="width: 100%; padding: 20px; text-align: left; position: relative;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 24px;">ğŸ“</span>
                <div>
                  <div style="font-weight: bold; font-size: 16px;">Google Driveã«ä¿å­˜</div>
                  <small style="display: block; font-size: 12px; opacity: 0.8; margin-top: 4px;">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã€ãƒªãƒ³ã‚¯å…±æœ‰ãŒå¯èƒ½</small>
                </div>
              </div>
            </button>
            
            
            <button class="btn" onclick="downloadZip(); closeModal();" style="width: 100%; padding: 20px; text-align: left; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; position: relative;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 24px;">ğŸ“¦</span>
                <div>
                  <div style="font-weight: bold; font-size: 16px;">ZIPã§ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</div>
                  <small style="display: block; font-size: 12px; opacity: 0.9; margin-top: 4px;">å…¨ç”»åƒã‚’1ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã¾ã¨ã‚ã¦ä¿å­˜</small>
                </div>
              </div>
            </button>
            
            <div style="border-top: 1px solid #eee; margin: 8px 0; padding-top: 16px;">
              <button class="btn" onclick="closeModal();" style="width: 100%; background: #f5f5f5; color: #666; border: 2px solid #ddd;">
                âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      window.closeModal = () => {
        document.body.removeChild(modal);
        delete window.closeModal;
        delete window.downloadToDrive;
        delete window.downloadZip;
      };
      
      window.downloadToDrive = () => {
        showTopMessage('ğŸ“ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ä¸­...', 'processing');
        google.script.run
          .withSuccessHandler(function(result) {
            hideTopMessage();
            showSuccessMessage(result, 5000);
          })
          .withFailureHandler(function(error) {
            hideTopMessage();
            showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          })
          .downloadSelectedImagesToDrive();
      };
      
      
      window.downloadZip = () => {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        showProgressModal();
        setProgressTitle('ğŸ“¦ ZIPä½œæˆä¸­...');
        startZipCreationProgress();
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideProgressModal();
            if (result.error) {
              showErrorMessage(result.error);
              return;
            }
            
            if (result.success && result.imageFiles) {
              // ãƒ­ãƒ¼ã‚«ãƒ«ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
              createAndDownloadZip(result.zipFileName, result.imageFiles, result.imageCount);
            } else {
              showErrorMessage('âŒ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          })
          .withFailureHandler(function(error) {
            hideProgressModal();
            showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          })
          .downloadSelectedImagesAsZip();
      };
    }
    
    
    
    function showImagePreview() {
      showTopMessage('ğŸ‘ï¸ ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(previewData) {
          hideTopMessage();
          if (previewData.length === 0) {
            showErrorMessage('âŒ è¡¨ç¤ºã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }
          
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9); z-index: 999999; display: flex;
            align-items: center; justify-content: center; overflow: auto;
          `;
          
          const gallery = previewData.map((img, i) => `
            <div style="text-align: center; margin: 16px;">
              <img src="${img.url}" style="max-width: 300px; max-height: 300px; border-radius: 8px;">
              <p style="color: white; margin: 8px 0; font-size: 12px;">${img.prompt.substring(0, 50)}...</p>
            </div>
          `).join('');
          
          modal.innerHTML = `
            <div style="background: white; border-radius: 16px; padding: 24px; max-width: 90vw; max-height: 90vh; overflow: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; color: #1a73e8;">ğŸ‘ï¸ ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (${previewData.length}æš)</h3>
                <button onclick="closePreview()" style="background: #ccc; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">âœ•</button>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                ${gallery}
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          window.closePreview = () => {
            document.body.removeChild(modal);
            delete window.closePreview;
          };
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .getAllImagePreviewData();
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function createAndDownloadZip(zipFileName, imageFiles, imageCount) {
      try {
        showTopMessage('ğŸ“¦ ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆä¸­...', 'processing');
        
        console.log('ZIPä½œæˆé–‹å§‹:', {
          fileName: zipFileName,
          fileCount: imageFiles.length,
          files: imageFiles.map(f => ({ name: f.filename, size: f.data.length }))
        });
        
        // ZIPä½œæˆï¼ˆPKZIPäº’æ›ï¼‰
        const zipData = createZipData(imageFiles);
        const blob = new Blob([zipData], { type: 'application/zip' });
        
        console.log('ZIPä½œæˆå®Œäº†:', {
          zipSize: blob.size,
          zipDataLength: zipData.length
        });
        
        // File System Access APIã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        if (window.showSaveFilePicker) {
          // ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
          saveFileWithPicker(blob, zipFileName, imageCount);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šè‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          downloadBlob(blob, zipFileName);
          showSuccessMessage(`âœ… ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼\n${imageCount}æšã®ç”»åƒã‚’ä¿å­˜`, 4000);
        }
      } catch (error) {
        console.error('ZIPä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        showErrorMessage('âŒ ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // File System Access APIã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    async function saveFileWithPicker(blob, filename, imageCount) {
      try {
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{
            description: 'ZIPã‚¢ãƒ¼ã‚«ã‚¤ãƒ–',
            accept: { 'application/zip': ['.zip'] }
          }]
        });
        
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        
        showSuccessMessage(`âœ… ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼\n${imageCount}æšã®ç”»åƒã‚’ä¿å­˜\nğŸ“ ä¿å­˜å…ˆ: ${filename}`, 5000);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          downloadBlob(blob, filename);
          showSuccessMessage(`âœ… ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼\n${imageCount}æšã®ç”»åƒã‚’ä¿å­˜`, 4000);
        }
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹å¼
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ZIPä½œæˆï¼ˆWindowsäº’æ›å½¢å¼ï¼‰
    function createZipData(imageFiles) {
      const files = [];
      let offset = 0;
      
      // ç¾åœ¨ã®æ—¥æ™‚ã‚’DOSå½¢å¼ã«å¤‰æ›
      const now = new Date();
      const dosTime = ((now.getHours() << 11) | (now.getMinutes() << 5) | (now.getSeconds() >> 1));
      const dosDate = (((now.getFullYear() - 1980) << 9) | ((now.getMonth() + 1) << 5) | now.getDate());
      
      // å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ˜ãƒƒãƒ€ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      for (const file of imageFiles) {
        const filenameBytes = new TextEncoder().encode(file.filename);
        const fileData = base64ToUint8Array(file.data);
        const crc32 = calculateCRC32(fileData);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ï¼ˆ30ãƒã‚¤ãƒˆ + ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
        const localHeader = new Uint8Array(30 + filenameBytes.length);
        const view = new DataView(localHeader.buffer);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ã‚·ã‚°ãƒãƒãƒ£
        view.setUint32(0, 0x04034b50, true);
        // å±•é–‹ã«å¿…è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ2.0ï¼‰
        view.setUint16(4, 20, true);
        // æ±ç”¨ãƒ“ãƒƒãƒˆãƒ•ãƒ©ã‚°
        view.setUint16(6, 0, true);
        // åœ§ç¸®æ–¹å¼ï¼ˆ0 = ç„¡åœ§ç¸®ï¼‰
        view.setUint16(8, 0, true);
        // æœ€çµ‚æ›´æ–°æ™‚åˆ»ï¼ˆDOSå½¢å¼ï¼‰
        view.setUint16(10, dosTime, true);
        // æœ€çµ‚æ›´æ–°æ—¥ä»˜ï¼ˆDOSå½¢å¼ï¼‰
        view.setUint16(12, dosDate, true);
        // CRC-32
        view.setUint32(14, crc32, true);
        // åœ§ç¸®ã‚µã‚¤ã‚º
        view.setUint32(18, fileData.length, true);
        // éåœ§ç¸®ã‚µã‚¤ã‚º
        view.setUint32(22, fileData.length, true);
        // ãƒ•ã‚¡ã‚¤ãƒ«åã®é•·ã•
        view.setUint16(26, filenameBytes.length, true);
        // æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é•·ã•
        view.setUint16(28, 0, true);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚³ãƒ”ãƒ¼
        localHeader.set(filenameBytes, 30);
        
        files.push({
          localHeader: localHeader,
          data: fileData,
          filename: filenameBytes,
          crc32: crc32,
          offset: offset,
          dosTime: dosTime,
          dosDate: dosDate
        });
        
        offset += localHeader.length + fileData.length;
      }
      
      const centralDirStart = offset;
      
      // ã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
      const centralDirRecords = [];
      for (const file of files) {
        const centralDirRecord = new Uint8Array(46 + file.filename.length);
        const view = new DataView(centralDirRecord.buffer);
        
        // ã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ã‚·ã‚°ãƒãƒãƒ£
        view.setUint32(0, 0x02014b50, true);
        // ä½œæˆã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆMS-DOSï¼‰
        view.setUint16(4, 0x0014, true);  // 2.0, MS-DOS
        // å±•é–‹ã«å¿…è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³
        view.setUint16(6, 20, true);
        // æ±ç”¨ãƒ“ãƒƒãƒˆãƒ•ãƒ©ã‚°
        view.setUint16(8, 0, true);
        // åœ§ç¸®æ–¹å¼
        view.setUint16(10, 0, true);
        // æœ€çµ‚æ›´æ–°æ™‚åˆ»
        view.setUint16(12, file.dosTime, true);
        // æœ€çµ‚æ›´æ–°æ—¥ä»˜
        view.setUint16(14, file.dosDate, true);
        // CRC-32
        view.setUint32(16, file.crc32, true);
        // åœ§ç¸®ã‚µã‚¤ã‚º
        view.setUint32(20, file.data.length, true);
        // éåœ§ç¸®ã‚µã‚¤ã‚º
        view.setUint32(24, file.data.length, true);
        // ãƒ•ã‚¡ã‚¤ãƒ«åã®é•·ã•
        view.setUint16(28, file.filename.length, true);
        // æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é•·ã•
        view.setUint16(30, 0, true);
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆã®é•·ã•
        view.setUint16(32, 0, true);
        // ãƒ‡ã‚£ã‚¹ã‚¯ç•ªå·é–‹å§‹
        view.setUint16(34, 0, true);
        // å†…éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«å±æ€§ï¼ˆãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        view.setUint16(36, 0, true);
        // å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«å±æ€§ï¼ˆMS-DOSäº’æ›ï¼‰
        view.setUint32(38, 0, true);  // é€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ã®ç›¸å¯¾ã‚ªãƒ•ã‚»ãƒƒãƒˆ
        view.setUint32(42, file.offset, true);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚³ãƒ”ãƒ¼
        centralDirRecord.set(file.filename, 46);
        
        centralDirRecords.push(centralDirRecord);
        offset += centralDirRecord.length;
      }
      
      const centralDirSize = offset - centralDirStart;
      
      // End of Central Directory Record
      const endRecord = new Uint8Array(22);
      const endView = new DataView(endRecord.buffer);
      
      // End of Central Directory ã‚·ã‚°ãƒãƒãƒ£
      endView.setUint32(0, 0x06054b50, true);
      // ã“ã®ãƒ‡ã‚£ã‚¹ã‚¯ã®ç•ªå·
      endView.setUint16(4, 0, true);
      // Central DirectoryãŒé–‹å§‹ã™ã‚‹ãƒ‡ã‚£ã‚¹ã‚¯ã®ç•ªå·
      endView.setUint16(6, 0, true);
      // ã“ã®ãƒ‡ã‚£ã‚¹ã‚¯ã®Central Directoryãƒ¬ã‚³ãƒ¼ãƒ‰æ•°
      endView.setUint16(8, files.length, true);
      // Central Directoryãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç·æ•°
      endView.setUint16(10, files.length, true);
      // Central Directoryã®ã‚µã‚¤ã‚º
      endView.setUint32(12, centralDirSize, true);
      // Central Directoryã®é–‹å§‹ã‚ªãƒ•ã‚»ãƒƒãƒˆ
      endView.setUint32(16, centralDirStart, true);
      // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆã®é•·ã•
      endView.setUint16(20, 0, true);
      
      // å…¨ä½“ã‚’çµåˆ
      const totalSize = offset + 22;
      const zipData = new Uint8Array(totalSize);
      let pos = 0;
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ã¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
      for (const file of files) {
        zipData.set(file.localHeader, pos);
        pos += file.localHeader.length;
        zipData.set(file.data, pos);
        pos += file.data.length;
      }
      
      // ã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
      for (const record of centralDirRecords) {
        zipData.set(record, pos);
        pos += record.length;
      }
      
      // End of Central Directory Recordã‚’è¿½åŠ 
      zipData.set(endRecord, pos);
      
      return zipData;
    }

    // Base64ã‚’Uint8Arrayã«å¤‰æ›
    function base64ToUint8Array(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    // CRC32è¨ˆç®—
    function calculateCRC32(data) {
      const crcTable = new Uint32Array(256);
      for (let i = 0; i < 256; i++) {
        let c = i;
        for (let j = 0; j < 8; j++) {
          c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
        }
        crcTable[i] = c;
      }
      
      let crc = 0xFFFFFFFF;
      for (let i = 0; i < data.length; i++) {
        crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
      }
      return crc ^ 0xFFFFFFFF;
    }

    function regenerateSelectedImages() {
      showTopMessage('ğŸ”„ é¸æŠç”»åƒã®å†ç”Ÿæˆã‚’é–‹å§‹...', 'processing');
      
      // é¸æŠç”»åƒå†ç”Ÿæˆå°‚ç”¨ã®é€²æ—
      showProgressModal();
      setProgressTitle('ğŸ”„ é¸æŠç”»åƒã‚’å†ç”Ÿæˆä¸­...');
      
      // ã¾ãšé¸æŠã•ã‚ŒãŸç”»åƒæšæ•°ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(selectedCount) {
          if (selectedCount > 0) {
            startProgressWithImageCount(selectedCount);
          } else {
            hideProgressModal();
            hideTopMessage();
            showErrorMessage('é¸æŠã•ã‚ŒãŸç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }
        })
        .withFailureHandler(function(error) {
          hideProgressModal();
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          return;
        })
        .getSelectedImageCount();
      
      google.script.run
        .withSuccessHandler(function(result) {
          completeImageGeneration();
          hideTopMessage();
          showSuccessMessage(result);
        })
        .withFailureHandler(function(error) {
          hideProgressModal();
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .regenerateSelectedImagesWithProgress();
    }

    function deleteSelectedRows() {
      showTopMessage('ğŸ—‘ï¸ é¸æŠè¡Œã‚’å‰Šé™¤ä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result);
          // å‰Šé™¤å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .deleteSelectedRows();
    }

    function deleteAllImagesWithConfirmation() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          showResult(result);
          // å‰Šé™¤å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
        })
        .withFailureHandler(function(error) {
          showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .deleteAllImagesWithConfirmation();
    }

    function createBackup() {
      showTopMessage('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result);
          // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
          // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .createBackupAndNewTable();
    }

    // ğŸ”¥ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†æ©Ÿèƒ½ã®æ”¹å–„ï¼šå…¥åŠ›ã‚·ãƒ¼ãƒˆã§ã®æ··ä¹±ã‚’è§£æ±º
    function toggleAllLibrarySelection() {
      // ã¾ãšç¾åœ¨ã®ã‚·ãƒ¼ãƒˆãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã‹ãƒã‚§ãƒƒã‚¯
      google.script.run
        .withSuccessHandler(function(isLibrarySheet) {
          if (!isLibrarySheet) {
            // å…¥åŠ›ã‚·ãƒ¼ãƒˆã®å ´åˆï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
            showResult('ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™...', false);
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
              })
              .switchToLibraryAndToggleSelection();
          } else {
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã®å ´åˆï¼šç›´æ¥å®Ÿè¡Œ
            showLoading();
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
              })
              .toggleAllLibrarySelection();
          }
        })
        .withFailureHandler(function(error) {
          showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .isCurrentSheetLibrary();
    }

    function downloadSelectedLibraryImages() {
      // ã¾ãšç¾åœ¨ã®ã‚·ãƒ¼ãƒˆãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã‹ãƒã‚§ãƒƒã‚¯
      google.script.run
        .withSuccessHandler(function(isLibrarySheet) {
          if (!isLibrarySheet) {
            // å…¥åŠ›ã‚·ãƒ¼ãƒˆã®å ´åˆï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
            showResult('ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™...', false);
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
              })
              .switchToLibraryAndDownload();
          } else {
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã®å ´åˆï¼šç›´æ¥å®Ÿè¡Œ
            showLoading();
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
              })
              .downloadSelectedLibraryImages();
          }
        })
        .withFailureHandler(function(error) {
          showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .isCurrentSheetLibrary();
    }

    // ğŸ”¥ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆå…¥åŠ›ã‚·ãƒ¼ãƒˆå¯¾å¿œæ”¹å–„ï¼‰
    function resetLibraryWithConfirmation() {
      // ã¾ãšç¾åœ¨ã®ã‚·ãƒ¼ãƒˆãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã‹ãƒã‚§ãƒƒã‚¯
      google.script.run
        .withSuccessHandler(function(isLibrarySheet) {
          if (!isLibrarySheet) {
            // å…¥åŠ›ã‚·ãƒ¼ãƒˆã®å ´åˆï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
            showResult('ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ãƒªã‚»ãƒƒãƒˆæ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™...', false);
            google.script.run
              .withSuccessHandler(function() {
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã«ç§»å‹•å¾Œã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showLibraryResetModal();
              })
              .withFailureHandler(function(error) {
                showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
              })
              .switchToLibrarySheet();
          } else {
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚·ãƒ¼ãƒˆã®å ´åˆï¼šç›´æ¥ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            showLibraryResetModal();
          }
        })
        .withFailureHandler(function(error) {
          showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .isCurrentSheetLibrary();
    }
    
    // ğŸ’¡ æ”¹å–„è¦æ±‚: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒªã‚»ãƒƒãƒˆã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«å®Ÿè£…
    function showLibraryResetModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.7); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“š</div>
            <h3 style="margin: 0; color: #d32f2f; font-size: 20px; font-weight: bold;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒªã‚»ãƒƒãƒˆã®ç¢ºèª</h3>
          </div>
          
          <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="color: #ef6c00; font-weight: bold; margin-bottom: 12px;">ğŸš¨ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã¨ã€å…¨ã¦ã®ç”Ÿæˆå±¥æ­´ãŒå¤±ã‚ã‚Œã¾ã™ï¼</div>
            <div style="color: #e65100; font-size: 14px; line-height: 1.6;">
              <strong>å‰Šé™¤ã•ã‚Œã‚‹å†…å®¹ï¼š</strong><br>
              â€¢ éå»ã®å…¨ã¦ã®ç”»åƒç”Ÿæˆè¨˜éŒ²<br>
              â€¢ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå±¥æ­´<br>
              â€¢ ç”Ÿæˆæ—¥æ™‚æƒ…å ±<br>
              â€¢ ãã®ä»–ã®å…¨ã¦ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‡ãƒ¼ã‚¿<br><br>
              <strong style="color: #d32f2f;">âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</strong><br>
              <strong style="color: #2e7d32;">âœ… æ–°ã—ã„ç©ºç™½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½œæˆã•ã‚Œã¾ã™</strong>
            </div>
          </div>
          
          <div style="text-align: center; color: #424242; font-size: 14px; margin-bottom: 24px;">
            æœ¬å½“ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="cancelLibraryReset()" style="
              flex: 1; padding: 14px; border: 2px solid #ccc; background: white; 
              color: #666; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
              âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button onclick="confirmLibraryReset()" style="
              flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
              color: white; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(244, 67, 54, 0.4)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(244, 67, 54, 0.3)'">
              ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
      window.cancelLibraryReset = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelLibraryReset;
        delete window.confirmLibraryReset;
      };
      
      window.confirmLibraryReset = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelLibraryReset;
        delete window.confirmLibraryReset;
        
        // å®Ÿéš›ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ
        proceedWithLibraryReset();
      };
    }
    
    // ğŸ’¡ æ”¹å–„è¦æ±‚: ç¢ºèªå¾Œã®å®Ÿéš›ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒªã‚»ãƒƒãƒˆå‡¦ç†
    function proceedWithLibraryReset() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          showResult(result);
        })
        .withFailureHandler(function(error) {
          showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .resetImageLibrary();
    }
    
    // ğŸ”„ çµåˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€æ‹¬æ›´æ–°æ©Ÿèƒ½
    function updateAllCombinedPrompts() {
      showTopMessage('ğŸ”„ çµåˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸€æ‹¬æ›´æ–°ä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 4000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .updateAllCombinedPrompts();
    }

    // ğŸ†• UXæ”¹å–„: åˆæœŸåŒ–å®Œäº†å¾Œã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
    function resetSidebarAfterInitialization() {
      try {
        console.log('ğŸ”„ åˆæœŸåŒ–å®Œäº†å¾Œã®UXãƒªã‚»ãƒƒãƒˆã‚’é–‹å§‹');
        
        // 1. ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ãƒˆãƒƒãƒ—è¡¨ç¤ºã«æˆ»ã™
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        const container = document.querySelector('.container');
        if (container) {
          container.scrollTop = 0;
        }
        
        // 2. ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        updateStepIndicator('step1');
        
        // 3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        hideLoading();
        hideProgressModal();
        
        // 4. ãƒˆãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showTopMessage('âœ… åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã‚’é–‹å§‹ã§ãã¾ã™', 'success', 4000);
        
        // 5. æ–°ã—ã„ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹ã«åˆã‚ã›ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–° - ç„¡åŠ¹åŒ–
        // setTimeout(function() {
        //   // checkSheetState(); // å®Œå…¨ç„¡åŠ¹åŒ– - å‹•ä½œè»½é‡åŒ–
        //   console.log('âœ… åˆæœŸåŒ–å®Œäº†å¾Œã®UXãƒªã‚»ãƒƒãƒˆå®Œäº†');
        // }, 500);
        console.log('âœ… åˆæœŸåŒ–å®Œäº†å¾Œã®UXãƒªã‚»ãƒƒãƒˆå®Œäº†');
        
        // 6. å…¥åŠ›ã‚·ãƒ¼ãƒˆãŒå·¦ç«¯ã«ç§»å‹•ã—ãŸã“ã¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ - ç„¡åŠ¹åŒ–
        // setTimeout(function() {
        //   showTopMessage('ğŸ“‹ å…¥åŠ›ã‚·ãƒ¼ãƒˆãŒå·¦ç«¯ã«é…ç½®ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å³ç«¯ã«ã‚ã‚Šã¾ã™', 'info', 3000);
        // }, 5000);
        showTopMessage('ğŸ“‹ å…¥åŠ›ã‚·ãƒ¼ãƒˆãŒå·¦ç«¯ã«é…ç½®ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å³ç«¯ã«ã‚ã‚Šã¾ã™', 'info', 3000);
        
      } catch (error) {
        console.error('UXãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // âœ… å…¨é¸æŠå°‚ç”¨æ©Ÿèƒ½
    function selectAllImagesUI() {
      showTopMessage('â˜‘ï¸ å…¨é¸æŠä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .selectAllImages();
    }

    // âŒ å…¨é¸æŠè§£é™¤å°‚ç”¨æ©Ÿèƒ½
    function clearAllImageSelectionUI() {
      showTopMessage('âŒ å…¨é¸æŠè§£é™¤ä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .clearAllImageSelection();
    }

    // âœ… ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨é¸æŠå°‚ç”¨æ©Ÿèƒ½
    function selectAllLibraryImagesUI() {
      showTopMessage('â˜‘ï¸ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨é¸æŠä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .selectAllLibraryImages();
    }

    // âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨é¸æŠè§£é™¤å°‚ç”¨æ©Ÿèƒ½
    function clearAllLibrarySelectionUI() {
      showTopMessage('âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¨é¸æŠè§£é™¤ä¸­...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .clearAllLibrarySelection();
    }

    // ğŸ” ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨ºæ–­æ©Ÿèƒ½
    function diagnoseLibraryImages() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          // ğŸš€ UXæ”¹å–„ï¼šè¨ºæ–­çµæœã‚‚ä¸Šéƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã«çµ±ä¸€
          showTopMessage(result, 'info', 10000);
        })
        .withFailureHandler(function(error) {
          showResult('è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .diagnoseLibraryImageIssues();
    }

    // ï¿½ï¿½ å…¨ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶æœ‰åŠ¹åŒ–ï¼ˆè»½é‡åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰
    function forceEnableAllButtons() {
      console.log('ğŸ”¥ å…¨ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶æœ‰åŠ¹åŒ–ï¼ˆè»½é‡åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰');
      
      // å…¨ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–
      const buttons = ['setupBtn', 'generateBtn', 'backupBtn', 'restoreBtn'];
      buttons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('disabled');
          btn.title = '';
        }
      });
      
      // ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      const managementSection = document.getElementById('managementSection');
      if (managementSection) {
        managementSection.style.display = 'block';
      }
    }
  </script>
</body>
</html> 