<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>üé® DALL-E ÁîªÂÉèÁîüÊàê„ÉÑ„Éº„É´</title>
  <style>
    body {
      font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-size: 14px;
    }

    .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    /* üö® ‰∏äÈÉ®Âõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */
    .top-message {
      position: fixed;
      top: 12px;
      left: 12px;
      right: 12px;
      z-index: 10000;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      animation: slideDown 0.3s ease-out;
      max-width: calc(100vw - 24px);
    }

    .top-message.success {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(139, 195, 74, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.95) 0%, rgba(229, 57, 53, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.95) 0%, rgba(255, 152, 0, 0.95) 100%);
      color: #333;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.info {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.95) 0%, rgba(30, 136, 229, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
    }

    .top-message.processing {
      background: linear-gradient(135deg, rgba(156, 39, 176, 0.95) 0%, rgba(123, 31, 162, 0.95) 100%);
      color: white;
      border-color: rgba(255,255,255,0.4);
      animation: pulse 2s infinite;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.95; }
      50% { opacity: 1; }
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.2);
    }

    h2 {
      color: #1a73e8;
      margin: 0 0 20px 0;
      font-size: 22px;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 0 8px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 15px;
      right: -50%;
      width: 100%;
      height: 2px;
      background-color: #e0e0e0;
      z-index: 1;
    }

    .step.active:not(:last-child)::after {
      background-color: #1a73e8;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
      font-weight: bold;
      font-size: 12px;
      position: relative;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .step.active .step-number {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4);
    }

    .step-text {
      font-size: 11px;
      color: #666;
      font-weight: 500;
      line-height: 1.2;
    }

    .step.active .step-text {
      color: #1a73e8;
      font-weight: bold;
    }

    .instructions {
      background: linear-gradient(135deg, rgba(255, 243, 224, 0.9) 0%, rgba(255, 248, 225, 0.9) 100%);
      border: 1px solid rgba(255, 152, 0, 0.3);
      color: #ef6c00;
      padding: 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 20px;
      line-height: 1.5;
      backdrop-filter: blur(5px);
    }

    /* üéØ „Çµ„Ç§„Ç∫ÈÅ∏ÊäûUI */
    .size-selector-container {
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(26, 115, 232, 0.08) 0%, rgba(67, 133, 244, 0.08) 100%);
      border-radius: 12px;
      border: 1px solid rgba(26, 115, 232, 0.2);
    }

    .size-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 8px;
      text-align: center;
    }

    .size-selector {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(26, 115, 232, 0.3);
      border-radius: 8px;
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
    }

    .size-selector:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);
    }

    .size-selector:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      width: 100%;
      margin-bottom: 12px;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .btn:active {
      transform: translateY(-1px) scale(0.98);
      transition: all 0.1s;
    }

    .btn-setup {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      font-size: 16px;
      font-weight: 800;
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-setup:hover {
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      box-shadow: 0 15px 35px rgba(240, 147, 251, 0.5);
      transform: translateY(-4px) scale(1.03);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 6px 20px rgba(17, 153, 142, 0.25);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
      box-shadow: 0 12px 30px rgba(17, 153, 142, 0.4);
    }

    .btn-create {
      background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);
      box-shadow: 0 6px 20px rgba(255, 106, 0, 0.25);
    }

    .btn-create:hover {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
      box-shadow: 0 12px 30px rgba(255, 106, 0, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      color: white;
      box-shadow: 0 6px 20px rgba(229, 62, 62, 0.25);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #c53030 0%, #b91c1c 100%);
      box-shadow: 0 12px 30px rgba(229, 62, 62, 0.4);
    }

    /* „Éú„Çø„É≥ÁÑ°ÂäπÂåñ„Çπ„Çø„Ç§„É´ */
    .btn:disabled,
    .btn.disabled {
      background: linear-gradient(135deg, #cccccc 0%, #999999 100%) !important;
      color: #666666 !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      opacity: 0.6;
    }

    .btn:disabled::before,
    .btn.disabled::before {
      display: none;
    }

    .btn:disabled:hover,
    .btn.disabled:hover {
      transform: none !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      background: linear-gradient(135deg, #cccccc 0%, #999999 100%) !important;
    }

    .button-group {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* „Éú„Çø„É≥„Çª„ÇØ„Ç∑„Éß„É≥ */
    .button-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 14px;
      font-weight: bold;
      color: #1a73e8;
      margin-bottom: 8px;
      padding: 4px 8px;
      background: rgba(26, 115, 232, 0.1);
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(26, 115, 232, 0.2);
    }

    .button-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    .btn-small {
      flex: 1;
      padding: 12px 8px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* üöÄ UXÊîπÂñÑÔºö‰∏ãÈÉ®Ë°®Á§∫ÂâäÈô§Ôºà‰∏äÈÉ®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Å´Áµ±‰∏ÄÔºâ */

    /* „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„É¢„Éº„ÉÄ„É´ */
    .progress-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      z-index: 999999;
      backdrop-filter: blur(8px);
      pointer-events: all;
    }

    .progress-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 50px;
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      text-align: center;
      min-width: 500px;
      max-width: 600px;
      width: 90vw;
      max-height: 80vh;
      overflow: auto;
      z-index: 1000000;
    }

    .progress-title {
      font-size: 28px;
      font-weight: bold;
      color: #1a73e8;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    .progress-bar-container {
      width: 100%;
      height: 24px;
      background: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin: 30px 0;
      box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #1a73e8, #4285f4, #34a853);
      border-radius: 10px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      font-size: 20px;
      color: #333;
      margin: 15px 0;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .progress-step {
      font-size: 16px;
      color: #666;
      margin: 10px 0;
      font-weight: 500;
    }

    .progress-warning {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffc107;
      color: #856404;
      padding: 20px;
      border-radius: 16px;
      margin-top: 30px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }

    .progress-warning-icon {
      font-size: 24px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 768px) {
      .progress-container {
        min-width: 300px;
        width: 95vw;
        padding: 30px 20px;
        max-height: 90vh;
      }

      .progress-title {
        font-size: 24px;
        margin-bottom: 20px;
        gap: 10px;
      }

      .progress-spinner {
        width: 40px;
        height: 40px;
        border-width: 4px;
      }

      .progress-text {
        font-size: 18px;
        margin: 12px 0;
      }

      .progress-step {
        font-size: 14px;
        margin: 8px 0;
      }

      .progress-warning {
        padding: 15px;
        font-size: 14px;
        margin-top: 20px;
        gap: 10px;
      }

      .progress-warning-icon {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .progress-container {
        min-width: 280px;
        width: 98vw;
        padding: 25px 15px;
      }

      .progress-title {
        font-size: 20px;
        flex-direction: column;
        gap: 8px;
      }

      .progress-text {
        font-size: 16px;
      }

      .progress-step {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- üö® ‰∏äÈÉ®Âõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ -->
    <div id="topMessage" class="top-message" style="display: none;">
      <div id="topMessageContent"></div>
    </div>
    
    <div class="card">
      <h2>üé® DALL-E ÁîªÂÉèÁîüÊàê</h2>
      
      <div class="step-indicator">
        <div class="step active" id="step1">
          <div class="step-number">1</div>
          <div class="step-text">„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó</div>
        </div>
        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div class="step-text">„Éó„É≠„É≥„Éó„Éà<br>ÂÖ•Âäõ</div>
        </div>
        <div class="step" id="step3">
          <div class="step-number">3</div>
          <div class="step-text">ÁîªÂÉèÁîüÊàê</div>
        </div>
      </div>

      <div class="instructions">
        <div id="instruction-text">
          <strong>üöÄ Á∞°Âçò3„Çπ„ÉÜ„ÉÉ„Éó:</strong><br>
          <strong>1Ô∏è‚É£</strong> Ë°®„ÇíÂàùÊúüÂåñ ‚Üí <strong>2Ô∏è‚É£</strong> „Éó„É≠„É≥„Éó„Éà„ÉªÁîªË≥™ÂÖ•Âäõ ‚Üí <strong>3Ô∏è‚É£</strong> ÁîªÂÉèÁîüÊàê
        </div>
      </div>

      <div class="button-group">
        <!-- Âü∫Êú¨Êìç‰Ωú„Ç∞„É´„Éº„Éó -->
        <div class="button-section">
          <div class="section-title">üìã Âü∫Êú¨Êìç‰Ωú</div>
          <button class="btn btn-setup" id="setupBtn" onclick="executeSetupWithBackup()" title="„Éá„Éº„Çø„ÇíÂÆâÂÖ®„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Å¶„Åã„ÇâÂàùÊúüÂåñ„Åó„Åæ„Åô">
            üîß Ë°®„ÇíÂàùÊúüÂåñ
          </button>
          
          <button class="btn btn-warning" onclick="updateAllCombinedPrompts()" title="ÂÖ®Ë°å„ÅÆÁµêÂêà„Éó„É≠„É≥„Éó„ÉàÔºàDÂàóÔºâ„Çí‰∏ÄÊã¨Êõ¥Êñ∞„Åó„Åæ„Åô">
            üîÑ ÁµêÂêà„Éó„É≠„É≥„Éó„ÉàÊõ¥Êñ∞
          </button>

          <!-- üéØ „É¢„Éá„É´ÈÅ∏ÊäûÊ©üËÉΩ -->
          <div class="size-selector-container">
            <label for="modelSelector" class="size-label">ü§ñ ÁîüÊàê„É¢„Éá„É´</label>
            <select id="modelSelector" class="size-selector" title="ÁîªÂÉèÁîüÊàê„Å´‰ΩøÁî®„Åô„Çã„É¢„Éá„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
              <option value="dall-e-3">DALL-E 3 ($0.02-$0.08)</option>
              <option value="gpt-image-1" selected>GPT-Image-1 ($2-$10) „Äê„Éá„Éï„Ç©„É´„Éà„Äë</option>
            </select>
          </div>

          <!-- üéØ „Çµ„Ç§„Ç∫ÈÅ∏ÊäûÊ©üËÉΩ -->
          <div class="size-selector-container">
            <label for="sizeSelector" class="size-label">üìê ÁîªÂÉè„Çµ„Ç§„Ç∫</label>
            <select id="sizeSelector" class="size-selector" title="ÈÅ∏Êäû„Åó„Åü„Çµ„Ç§„Ç∫„ÅåÊúÄÂÑ™ÂÖà„ÅßÈÅ©Áî®„Åï„Çå„Åæ„Åô">
              <option value="">ü§ñ Ëá™ÂãïÂà§ÂÆö („Éó„É≠„É≥„Éó„ÉàËß£Êûê)</option>
              <option value="1024x1024">üü© Ê≠£ÊñπÂΩ¢ (1024√ó1024)</option>
              <option value="1536x1024">üìê Ê®™Èï∑ (1536√ó1024)</option>
              <option value="1024x1536">üì± Á∏¶Èï∑ (1024√ó1536)</option>
            </select>
          </div>
          
          <button class="btn" id="generateBtn" onclick="generateFromStructuredTable()" title="„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
            üé® ÁîªÂÉèÁîüÊàê
          </button>
        </div>

        <!-- ÁÆ°ÁêÜÊìç‰Ωú„Ç∞„É´„Éº„ÉóÔºàÁîªÂÉèÁîüÊàêÂæå„Å´Ë°®Á§∫Ôºâ -->
        <div class="button-section" id="managementSection" style="display: none;">
          <div class="section-title">üõ†Ô∏è ÁîªÂÉèÁÆ°ÁêÜ</div>
          <div class="button-row">
            <button class="btn btn-secondary btn-small" onclick="selectAllImagesUI()">
              ‚òëÔ∏è ÂÖ®ÈÅ∏Êäû
            </button>
            <button class="btn btn-secondary btn-small" onclick="clearAllImageSelectionUI()">
              ‚ùå ÂÖ®ÈÅ∏ÊäûËß£Èô§
            </button>
          </div>
          <div class="button-row">
            <button class="btn btn-small" onclick="showDownloadOptions()">
              üì• „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            </button>
            <button class="btn btn-small" onclick="regenerateSelectedImages()">
              üîÑ ÂÜçÁîüÊàê
            </button>
          </div>
          <div class="button-row">
                              <button class="btn btn-danger btn-small" onclick="deleteSelectedRows()">
                    üóëÔ∏è ÈÅ∏ÊäûË°å„ÇíÂâäÈô§
                  </button>
            <!-- ÂÖ®ÂâäÈô§„Éú„Çø„É≥„ÇíÂâäÈô§ -->
          </div>
        </div>

        <!-- „É©„Ç§„Éñ„É©„É™Êìç‰Ωú„Ç∞„É´„Éº„ÉóÔºàüí° ÊîπÂñÑË¶ÅÊ±Ç: „É©„Ç§„Éñ„É©„É™„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩËøΩÂä†Ôºâ -->
        <div class="button-section" id="librarySection">
          <div class="section-title">üìö „É©„Ç§„Éñ„É©„É™ÁÆ°ÁêÜ</div>
          <div class="button-row">
            <button class="btn btn-secondary btn-small" onclick="selectAllLibraryImagesUI()">
              ‚òëÔ∏è „É©„Ç§„Éñ„É©„É™ÂÖ®ÈÅ∏Êäû
            </button>
            <button class="btn btn-secondary btn-small" onclick="clearAllLibrarySelectionUI()">
              ‚ùå „É©„Ç§„Éñ„É©„É™ÂÖ®Ëß£Èô§
            </button>
          </div>
          <div class="button-row">
            <button class="btn btn-create btn-small" onclick="downloadSelectedLibraryImages()">
              üì• „É©„Ç§„Éñ„É©„É™DL
            </button>
            <button class="btn btn-danger btn-small" onclick="resetLibraryWithConfirmation()">
              üóëÔ∏è „É©„Ç§„Éñ„É©„É™„É™„Çª„ÉÉ„Éà
            </button>
          </div>
        </div>

        <!-- „Åù„ÅÆ‰ªñÊìç‰Ωú„Ç∞„É´„Éº„Éó -->
        <div class="button-section">
          <div class="section-title">‚öôÔ∏è „Åù„ÅÆ‰ªñ</div>
          <div class="button-row">
            <button class="btn btn-secondary btn-small" id="backupBtn" onclick="createBackup()" style="display: none;">
              üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            </button>
          </div>
        </div>
      </div>

      <!-- ‰∏ãÈÉ®„ÅÆÂá¶ÁêÜË°®Á§∫„ÇíÂâäÈô§ - ‰∏äÈÉ®Âõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÁµ±‰∏Ä -->
    </div>
  </div>

  <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„É¢„Éº„ÉÄ„É´ -->
  <div class="progress-modal" id="progressModal">
    <div class="progress-container">
      <div class="progress-title">
        <div class="progress-spinner"></div>
        <span id="progressTitle">üé® ÁîªÂÉèÁîüÊàê‰∏≠...</span>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      
      <div class="progress-text" id="progressText">Ê∫ñÂÇô‰∏≠...</div>
      <div class="progress-step" id="progressStep">„Çπ„ÉÜ„ÉÉ„Éó 1/9</div>
      
      <div class="progress-warning">
        <span class="progress-warning-icon">‚ö†Ô∏è</span>
        <span>ÁîªÂÉèÁîüÊàê‰∏≠„ÅØ„Ç∑„Éº„Éà„ÅÆÁ∑®ÈõÜ„Åå„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ</span>
      </div>
    </div>
  </div>

  <script>
    // üî•üî•üî• Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®Ê†πÁµ∂ÔºàÈôêÁïåÁ™ÅÁ†¥ÁâàÔºâüî•üî•üî•
    // window.addEventListener('load', () => {
    //   // üö® ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - GoogleÂÜÖÈÉ®Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†ÈÄ£ÈéñÂèçÂøú„ÇíÊ†πÁµ∂
    //   setTimeout(() => {
    //     checkSheetStateOnce();
    //   }, 500);
    // });
    
    // üî• Á∑äÊÄ•ÂÅúÊ≠¢„Ç∑„Çπ„ÉÜ„É†: ÂÖ®IntervalÂº∑Âà∂ÂÅúÊ≠¢
    function forceStopAllIntervals() {
      console.log('üö® Á∑äÊÄ•ÂÅúÊ≠¢„Ç∑„Çπ„ÉÜ„É†ÂÆüË°å‰∏≠...');
      // window „É¨„Éô„É´„ÅÆÂÖ® Interval „ÇíÂº∑Âà∂ÂÅúÊ≠¢Ôºà1-1000Áï™Ôºâ
      for (let i = 1; i <= 1000; i++) {
        clearInterval(i);
        clearTimeout(i);
      }
      console.log('‚úÖ ÂÖ® Interval/Timeout Âº∑Âà∂ÂÅúÊ≠¢ÂÆå‰∫Ü');
    }
    
    // üî• Á∑äÊÄ•„É™„Çª„ÉÉ„Éà: „Çµ„Ç§„Éâ„Éê„ÉºÂÆåÂÖ®„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ
    function emergencyResetSidebar() {
      try {
        forceStopAllIntervals();
        forceEnableAllButtons();
        console.log('üö® Á∑äÊÄ•„Çµ„Ç§„Éâ„Éê„Éº„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü');
      } catch (error) {
        console.log('üî• Á∑äÊÄ•„É™„Çª„ÉÉ„Éà‰∏≠„Å´„Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÔºâ:', error);
      }
    }
    
    // üéØ „É¢„Éá„É´ÈÅ∏ÊäûÊ©üËÉΩÔºàËªΩÈáèÂåñÁâà - „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÊúÄÂ∞èÂåñÔºâ
    document.addEventListener('DOMContentLoaded', function() {
      // 60Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„ÅçÊô∫ÁöÑÁõ£Ë¶ñÔºà1Âõû„ÅÆ„ÅøÔºâ
      let executionCount = 0;
      const maxExecutions = 1;
      
      function smartInitialization() {
        if (executionCount >= maxExecutions) {
          console.log('üõ°Ô∏è ÂÆüË°åÂà∂Èôê: Êô∫ÁöÑÁõ£Ë¶ñ„ÅØ1Âõû„ÅÆ„ÅøÂÆüË°å');
          return;
        }
        
        executionCount++;
        
        try {
          // „É¢„Éá„É´ÈÅ∏ÊäûÊôÇ„ÅÆ„Ç≥„Çπ„ÉàË≠¶ÂëäÔºà„Éá„Éê„Ç¶„É≥„ÇπÊ©üËÉΩ‰ªò„ÅçÔºâ
          const modelSelector = document.getElementById('modelSelector');
          if (modelSelector && !modelSelector._listenerAdded) {
            let lastExecution = 0;
            const debounceTime = 5000; // 5Áßí„Éá„Éê„Ç¶„É≥„Çπ
            
            modelSelector.addEventListener('change', function() {
              const now = Date.now();
              if (now - lastExecution < debounceTime) {
                console.log('üõ°Ô∏è „Éá„Éê„Ç¶„É≥„Çπ: „É¢„Éá„É´Â§âÊõ¥ÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
              }
              lastExecution = now;
              
              const selectedModel = this.value;
              if (selectedModel === 'dall-e-3') {
                showTopMessage('DALL-E 3„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü (1Êûö$0.02-$0.08) - „Ç≥„Çπ„ÉàÂäπÁéáÈáçË¶ñ', 'success', 4000);
              } else {
                showTopMessage('GPT-Image-1„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü (1Êûö$2-$10) - È´òÂìÅË≥™ÈáçË¶ñ', 'info', 4000);
              }
            });
            modelSelector._listenerAdded = true;
          }
          
          // 60Áßí„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂº∑Âà∂ÁµÇ‰∫Ü - ÁÑ°ÂäπÂåñ
          // setTimeout(() => {
          //   emergencyResetSidebar();
          //   console.log('‚è∞ 60Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà: Êô∫ÁöÑÁõ£Ë¶ñÁµÇ‰∫Ü');
          // }, 60000);
          
        } catch (error) {
          console.log('üî• Êô∫ÁöÑÁõ£Ë¶ñ„Ç®„É©„ÉºÔºàÁÑ°Ë¶ñÔºâ:', error);
        }
      }
      
      // Êô∫ÁöÑÁõ£Ë¶ñ„ÅÆÂÆâÂÖ®ÂÆüË°å - ÁÑ°ÂäπÂåñ
      // setTimeout(smartInitialization, 100);
      // Áõ¥Êé•ÂÆüË°å„Å´Â§âÊõ¥
      smartInitialization();
      
      // üî• ÁîªÂÉèÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥Âê´„ÇÄÔºâ„ÇíÂº∑Âà∂Ë°®Á§∫
      const managementSection = document.getElementById('managementSection');
      if (managementSection) {
        managementSection.style.display = 'block';
        console.log('‚úÖ ÁîªÂÉèÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥Âê´„ÇÄÔºâ„ÇíË°®Á§∫');
      }
    });

    // üöÄ ÂÖ®„Å¶„ÅÆÂÆöÊúüÁõ£Ë¶ñ„ÇíÂÆåÂÖ®ÂâäÈô§ÔºàÂãï‰ΩúËªΩÈáèÂåñÔºâ
    // window.addEventListener('focus', checkSheetState); // ÂâäÈô§
    // document.addEventListener('visibilitychange', checkSheetState); // ÂâäÈô§

    // üî• Âãï‰ΩúËªΩÈáèÂåñÔºöÂàùÂõû„ÅÆ„ÅøÂÆüË°å„Åô„ÇãËªΩÈáèÁâà
    // üî•üî•üî• checkSheetStateOnceÂÆåÂÖ®ÂâäÈô§ÔºàÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†Ê†πÁµ∂Ôºâüî•üî•üî•
    // function checkSheetStateOnce() {
    //   console.log('üî• ÂàùÂõûÁä∂ÊÖãÁ¢∫Ë™çÔºàËªΩÈáèÂåñ„É¢„Éº„ÉâÔºâ');
    //   
    //   // üî• ËªΩÈáèÂåñÔºöGoogle ScriptsÈÄö‰ø°„ÇíÂâäÈô§„Åó„ÄÅÁõ¥Êé•„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
    //   setTimeout(() => {
    //     forceEnableAllButtons();
    //     console.log('‚úÖ ÂàùÂõûÁä∂ÊÖãÁ¢∫Ë™çÂÆå‰∫ÜÔºàËªΩÈáèÂåñ„É¢„Éº„ÉâÔºâ');
    //   }, 100);
    // }

    // üî•üî•üî• checkSheetStateÈñ¢Êï∞„ÇíÂÆåÂÖ®ÂâäÈô§ÔºàÁõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†Ê†πÁµ∂Ôºâüî•üî•üî•
    // function checkSheetState() {
    //   // üî• ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàËªΩÈáèÂåñ„ÅÆ„Åü„ÇÅÔºâ
    //   console.log('üî• checkSheetStateÂëº„Å≥Âá∫„Åó„ÇíÁÑ°ÂäπÂåñÔºàËªΩÈáèÂåñ„É¢„Éº„ÉâÔºâ');
    //   return;
    // }

    // ‰∏ãÈÉ®„ÅÆÂá¶ÁêÜË°®Á§∫„Çí‰∏äÈÉ®Âõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏„Å´Áµ±‰∏Ä
    function showLoading() {
      showTopMessage('üîÑ Âá¶ÁêÜ‰∏≠...', 'processing');
    }

    function hideLoading() {
      hideTopMessage();
    }

    function showResult(message, isError = false) {
      hideTopMessage();
      // üöÄ UXÊîπÂñÑÔºöÂÖ®„Å¶‰∏äÈÉ®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Å´Áµ±‰∏Ä
      if (isError) {
        showTopMessage(message, 'error', 6000);
      } else {
        showTopMessage(message, 'success', 4000);
      }
    }

    // üö® ‰∏äÈÉ®Âõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
    function showTopMessage(message, type = 'info', duration = 5000) {
      const messageDiv = document.getElementById('topMessage');
      const contentDiv = document.getElementById('topMessageContent');
      
      // „É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ„ÇíË®≠ÂÆö
      contentDiv.textContent = message;
      
      // „Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíË®≠ÂÆö
      messageDiv.className = `top-message ${type}`;
      messageDiv.style.display = 'block';
      
      // Ëá™ÂãïÈùûË°®Á§∫ÔºàÂá¶ÁêÜ‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏‰ª•Â§ñÔºâ- ÁÑ°ÂäπÂåñ
      // if (type !== 'processing') {
      //   setTimeout(() => {
      //     hideTopMessage();
      //   }, duration);
      // }
    }

    function hideTopMessage() {
      const messageDiv = document.getElementById('topMessage');
      messageDiv.style.display = 'none';
    }

    // Âá¶ÁêÜ‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰æøÂà©Èñ¢Êï∞
    function showProcessingMessage(message) {
      showTopMessage(message, 'processing');
    }

    function showSuccessMessage(message, duration = 3000) {
      showTopMessage(message, 'success', duration);
    }

    function showErrorMessage(message, duration = 5000) {
      showTopMessage(message, 'error', duration);
    }

    function showWarningMessage(message, duration = 4000) {
      showTopMessage(message, 'warning', duration);
    }

    function updateStepIndicator(currentStep) {
      const steps = ['step1', 'step2', 'step3'];
      steps.forEach(step => {
        document.getElementById(step).classList.remove('active');
      });
      if (document.getElementById(currentStep)) {
        document.getElementById(currentStep).classList.add('active');
      }
    }

    // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÂà∂Âæ°Èñ¢Êï∞
    function showProgressModal() {
      const modal = document.getElementById('progressModal');
      modal.style.display = 'block';
      
      // Á¢∫ÂÆü„Å´ÊúÄÂâçÈù¢„Å´Ë°®Á§∫
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.zIndex = '999999';
      
      // „Éö„Éº„Ç∏„Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°ÂäπÂåñ
      document.body.style.overflow = 'hidden';
      
      updateProgress(0, 'Ê∫ñÂÇô‰∏≠...', '„Çπ„ÉÜ„ÉÉ„Éó 1/9');
    }

    function hideProgressModal() {
      const modal = document.getElementById('progressModal');
      modal.style.display = 'none';
      
      // „Éö„Éº„Ç∏„Çπ„ÇØ„É≠„Éº„É´„ÇíÂæ©ÂÖÉ
      document.body.style.overflow = 'auto';
    }

    function updateProgress(percentage, text, step) {
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressStep').textContent = step;
    }

    function setProgressTitle(title) {
      document.getElementById('progressTitle').textContent = title;
    }

    // ÁîªÂÉèÁîüÊàêÂ∞ÇÁî®„ÅÆÈÄ≤ÊçóÁÆ°ÁêÜÔºàÊîπËâØÁâàÔºâ
    function startImageGenerationProgress() {
      showProgressModal();
      setProgressTitle('üé® ÁîªÂÉèÁîüÊàê‰∏≠...');
      
      // „Åæ„ÅöÁîªÂÉèÊûöÊï∞„ÇíÂèñÂæó
      google.script.run
        .withSuccessHandler(function(imageCount) {
          startProgressWithImageCount(imageCount);
        })
        .withFailureHandler(function(error) {
          // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÈÄ≤Êçó„ÇíÈñãÂßã
          startProgressWithImageCount(1);
        })
        .getImageGenerationCount();
    }

    function startProgressWithImageCount(imageCount) {
      // üöÄ „Éê„ÉÉ„ÉÅÂá¶ÁêÜÂØæÂøú„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº
      const batchCount = Math.ceil(imageCount / (imageCount > 15 ? 6 : 5));
      const isBatchMode = imageCount > 8;
      
      let steps;
      if (isBatchMode) {
        // „Éê„ÉÉ„ÉÅÂá¶ÁêÜ„É¢„Éº„Éâ
        steps = [
          { inc: 10, text: `„Éó„É≠„É≥„Éó„Éà„ÇíËß£Êûê‰∏≠... (${imageCount}Êûö‰∫àÂÆö)`, duration: 600 },
          { inc: 10, text: 'DALL-E API„Å´Êé•Á∂ö‰∏≠...', duration: 600 },
          { inc: 10, text: 'APIË™çË®º„ÇíÁ¢∫Ë™ç‰∏≠...', duration: 600 },
          { inc: 15, text: `„Éê„ÉÉ„ÉÅÂá¶ÁêÜ„ÇíÈñãÂßã... (${batchCount}„Éê„ÉÉ„ÉÅ‰∫àÂÆö)`, duration: 800 },
          { inc: 40, text: `„Éê„ÉÉ„ÉÅÁîªÂÉèÁîüÊàê‰∏≠... (${imageCount}Êûö„Çí${batchCount}„Éê„ÉÉ„ÉÅ„ÅßÂá¶ÁêÜ)`, duration: Math.max(2000, batchCount * 1000) },
          { inc: 10, text: '„Éê„ÉÉ„ÉÅÁµêÊûú„ÇíÁµ±Âêà‰∏≠...', duration: 600 },
          { inc: 5, text: '„Ç∑„Éº„Éà„Å´ÈÖçÁΩÆ‰∏≠...', duration: 600 }
        ];
      } else {
        // ÈÄöÂ∏∏Âá¶ÁêÜ„É¢„Éº„Éâ
        steps = [
          { inc: 12, text: `„Éó„É≠„É≥„Éó„Éà„ÇíËß£Êûê‰∏≠... (${imageCount}Êûö‰∫àÂÆö)`, duration: 800 },
          { inc: 12, text: 'DALL-E API„Å´Êé•Á∂ö‰∏≠...', duration: 800 },
          { inc: 12, text: 'APIË™çË®º„ÇíÁ¢∫Ë™ç‰∏≠...', duration: 800 },
          { inc: 12, text: `ÁîªÂÉèÁîüÊàê„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°‰∏≠... (${imageCount}Êûö)`, duration: 800 },
          { inc: 28, text: `ÁîªÂÉè„ÇíÁîüÊàê‰∏≠... (${imageCount}Êûö)`, duration: Math.max(1500, imageCount * 800) },
          { inc: 12, text: 'ÁîüÊàêÁµêÊûú„ÇíÂèó‰ø°‰∏≠...', duration: 800 },
          { inc: 12, text: '„Ç∑„Éº„Éà„Å´ÈÖçÁΩÆ‰∏≠...', duration: 800 }
        ];
      }

      let progress = 0;
      let stepIdx = 0;
      updateProgress(progress, 'ÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...', '');

      function executeStep() {
        if (stepIdx < steps.length) {
          const step = steps[stepIdx];
          const targetProgress = progress + step.inc;
          
          // üîß **„Çπ„É†„Éº„Ç∫„Å™ÈÄ≤ÊçóË°®Á§∫**: ÊÆµÈöéÁöÑ„Å´ÈÄ≤Êçó„ÇíÊõ¥Êñ∞
          const startProgress = progress;
          const progressDuration = step.duration;
          const updateInterval = 100; // 100ms„Åî„Å®„Å´Êõ¥Êñ∞
          const totalUpdates = progressDuration / updateInterval;
          const progressPerUpdate = step.inc / totalUpdates;
          
          let currentUpdate = 0;
          const currentStepNumber = stepIdx + 1; // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÁï™Âè∑„ÇíÂõ∫ÂÆö
          
          updateProgress(progress, step.text, `„Çπ„ÉÜ„ÉÉ„Éó ${currentStepNumber}/${steps.length}`);
          
          // üî•üî•üî• setIntervalÂÆåÂÖ®ÁÑ°ÂäπÂåñÔºàÂãï‰ΩúËªΩÈáèÂåñÔºâüî•üî•üî•
          // const progressInterval = setInterval(() => {
          //   currentUpdate++;
          //   progress += progressPerUpdate;
          //   
          //   if (progress > 95) progress = 95;
          //   if (currentUpdate >= totalUpdates) {
          //     progress = Math.min(targetProgress, 95);
          //     clearInterval(progressInterval);
          //     stepIdx++;
          //     
          //     // ÊúÄÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂ†¥Âêà„ÅØ95%„ÅßÂæÖÊ©üÔºà„Çµ„Éº„Éê„ÉºÂá¶ÁêÜÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
          //     if (stepIdx >= steps.length) {
          //       updateProgress(95, 'ÊúÄÁµÇÂá¶ÁêÜ‰∏≠...', `„Çπ„ÉÜ„ÉÉ„Éó ${steps.length}/${steps.length}`);
          //     } else {
          //       setTimeout(executeStep, 100); // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å∏
          //     }
          //   }
          //   
          //   // Âõ∫ÂÆö„Åï„Çå„Åü„Çπ„ÉÜ„ÉÉ„ÉóÁï™Âè∑„Çí‰ΩøÁî®
          //   updateProgress(Math.round(progress), step.text, `„Çπ„ÉÜ„ÉÉ„Éó ${currentStepNumber}/${steps.length}`);
          // }, updateInterval);
          
          // Áõ¥Êé•ÈÄ≤ÊçóÊõ¥Êñ∞ÔºàsetIntervalÁÑ°ÂäπÂåñÔºâ
          progress = Math.min(targetProgress, 95);
          updateProgress(Math.round(progress), step.text, `„Çπ„ÉÜ„ÉÉ„Éó ${currentStepNumber}/${steps.length}`);
          stepIdx++;
          
          // ÊúÄÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂ†¥Âêà„ÅØ95%„ÅßÂæÖÊ©üÔºà„Çµ„Éº„Éê„ÉºÂá¶ÁêÜÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
          if (stepIdx >= steps.length) {
            updateProgress(95, 'ÊúÄÁµÇÂá¶ÁêÜ‰∏≠...', `„Çπ„ÉÜ„ÉÉ„Éó ${steps.length}/${steps.length}`);
          } else {
            // setTimeout(executeStep, 100); // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å∏ - ÁÑ°ÂäπÂåñ
            executeStep(); // Áõ¥Êé•ÂÆüË°å
          }
        }
      }
      
      executeStep();
    }

    function completeImageGeneration() {
      updateProgress(100, '‚úÖ ÁîªÂÉèÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ', 'ÂÆå‰∫Ü');
      // setTimeout(() => {
      //   hideProgressModal();
      // }, 1500);
      hideProgressModal(); // Áõ¥Êé•ÂÆüË°å
    }

    // ZIP‰ΩúÊàêÁî®„ÅÆ„Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫
    function startZipCreationProgress() {
      const steps = [
        { inc: 15, text: 'ÈÅ∏ÊäûÁîªÂÉè„ÇíÁ¢∫Ë™ç‰∏≠...', duration: 500 },
        { inc: 25, text: 'ZIP„Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê‰∏≠...', duration: 800 },
        { inc: 40, text: 'ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠...', duration: 2000 },
        { inc: 15, text: 'ZIP„Éï„Ç©„É´„ÉÄ„Å´‰øùÂ≠ò‰∏≠...', duration: 1000 },
        { inc: 5, text: 'ÂÖ±ÊúâË®≠ÂÆö„ÇíÈÅ©Áî®‰∏≠...', duration: 400 }
      ];

      let progress = 0;
      let stepIdx = 0;
      updateProgress(progress, 'Ê∫ñÂÇô‰∏≠...', '');

      function executeStep() {
        if (stepIdx < steps.length) {
          const step = steps[stepIdx];
          const targetProgress = progress + step.inc;
          
          const startProgress = progress;
          const progressDuration = step.duration;
          const updateInterval = 100;
          const totalUpdates = progressDuration / updateInterval;
          const progressPerUpdate = step.inc / totalUpdates;
          
          let currentUpdate = 0;
          const currentStepNumber = stepIdx + 1;
          
          updateProgress(progress, step.text, `„Çπ„ÉÜ„ÉÉ„Éó ${currentStepNumber}/${steps.length}`);
          
          // üî•üî•üî• setIntervalÂÆåÂÖ®ÁÑ°ÂäπÂåñÔºàÂãï‰ΩúËªΩÈáèÂåñÔºâüî•üî•üî•
          // const progressInterval = setInterval(() => {
          //   currentUpdate++;
          //   progress += progressPerUpdate;
          //   
          //   if (progress > 95) progress = 95;
          //   if (currentUpdate >= totalUpdates) {
          //     progress = Math.min(targetProgress, 95);
          //     clearInterval(progressInterval);
          //     stepIdx++;
          //     
          //     if (stepIdx >= steps.length) {
          //       updateProgress(95, 'ÊúÄÁµÇÂá¶ÁêÜ‰∏≠...', `„Çπ„ÉÜ„ÉÉ„Éó ${steps.length}/${steps.length}`);
          //     } else {
          //       setTimeout(executeStep, 100);
          //     }
          //   }
          //   
          //   updateProgress(Math.round(progress), step.text, `„Çπ„ÉÜ„ÉÉ„Éó ${currentStepNumber}/${steps.length}`);
          // }, updateInterval);
          
          // Áõ¥Êé•ÈÄ≤ÊçóÊõ¥Êñ∞ÔºàsetIntervalÁÑ°ÂäπÂåñÔºâ
          progress = Math.min(targetProgress, 95);
          updateProgress(Math.round(progress), step.text, `„Çπ„ÉÜ„ÉÉ„Éó ${currentStepNumber}/${steps.length}`);
          stepIdx++;
          
          if (stepIdx >= steps.length) {
            updateProgress(95, 'ÊúÄÁµÇÂá¶ÁêÜ‰∏≠...', `„Çπ„ÉÜ„ÉÉ„Éó ${steps.length}/${steps.length}`);
          } else {
            setTimeout(executeStep, 100);
          }
        }
      }
      
      executeStep();
    }

    // üí° Á∑äÊÄ•‰øÆÊ≠£: ÂÆâÂÖ®„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ªò„ÅçÂàùÊúüÂåñ
    function executeSetupWithBackup() {
      // „Éá„Éº„ÇøÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      showDataProtectionModal();
    }
    
    // üí° Á∑äÊÄ•‰øÆÊ≠£: „Éá„Éº„Çø‰øùË≠∑Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´
    function showDataProtectionModal() {
      // „Åæ„Åö„Ç∑„Éº„ÉàÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
      google.script.run
        .withSuccessHandler(function(hasData) {
          if (hasData) {
            // „Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç
            showBackupConfirmationModal();
          } else {
            // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁõ¥Êé•ÂàùÊúüÂåñ
            proceedWithDirectInitialization();
          }
        })
        .withFailureHandler(function(error) {
          // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÂÆâÂÖ®ÂÅ¥„Å´ÂÄí„Åó„Å¶„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç
          showBackupConfirmationModal();
        })
        .checkForAnyData();
    }
    
    // üí° Á∑äÊÄ•‰øÆÊ≠£: „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
    function showBackupConfirmationModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.8); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üíæ</div>
            <h3 style="margin: 0; color: #1976d2; font-size: 20px; font-weight: bold;">„Éá„Éº„Çø‰øùË≠∑Á¢∫Ë™ç</h3>
          </div>
          
          <div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="color: #2e7d32; font-weight: bold; margin-bottom: 12px;">‚úÖ Êó¢Â≠ò„Éá„Éº„Çø„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü</div>
            <div style="color: #388e3c; font-size: 14px; line-height: 1.6;">
              <strong>ÂÆâÂÖ®„Å™ÂàùÊúüÂåñÊñπÊ≥ïÔºö</strong><br>
              1Ô∏è‚É£ <strong>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ªò„ÅçÂàùÊúüÂåñ</strong>ÔºàÊé®Â•®Ôºâ<br>
              „ÄÄ„ÄÄ‚Üí ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç∑„Éº„Éà„Å´‰øùÂ≠ò„Åó„Å¶„Åã„ÇâÂàùÊúüÂåñ<br><br>
              2Ô∏è‚É£ <strong>Áõ¥Êé•ÂàùÊúüÂåñ</strong>ÔºàÂç±Èô∫Ôºâ<br>
              „ÄÄ„ÄÄ‚Üí „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„Åó„ÅßÂç≥Â∫ß„Å´ÂàùÊúüÂåñ<br><br>
              3Ô∏è‚É£ <strong>„Ç≠„É£„É≥„Çª„É´</strong><br>
              „ÄÄ„ÄÄ‚Üí „Éá„Éº„Çø„Çí‰øùÊåÅ„Åó„Åü„Åæ„ÅæÊìç‰Ωú„Çí„Ç≠„É£„É≥„Çª„É´
            </div>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="executeBackupAndInit()" style="
              padding: 16px; border: none; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); 
              color: white; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(76, 175, 80, 0.4)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)'">
              üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ªò„ÅçÂàùÊúüÂåñÔºàÊé®Â•®Ôºâ
            </button>
            <button onclick="executeDangerousInit()" style="
              padding: 12px; border: 2px solid #ff9800; background: white; 
              color: #f57c00; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#fff3e0'" onmouseout="this.style.background='white'">
              ‚ö†Ô∏è Áõ¥Êé•ÂàùÊúüÂåñÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„ÅóÔºâ
            </button>
            <button onclick="cancelDataProtection()" style="
              padding: 12px; border: 2px solid #ccc; background: white; 
              color: #666; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
              ‚ùå „Ç≠„É£„É≥„Çª„É´
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
      window.executeBackupAndInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.executeBackupAndInit;
        delete window.executeDangerousInit;
        delete window.cancelDataProtection;
        
        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ªò„ÅçÂàùÊúüÂåñ„ÇíÂÆüË°å
        proceedWithBackupInitialization();
      };
      
      window.executeDangerousInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.executeBackupAndInit;
        delete window.executeDangerousInit;
        delete window.cancelDataProtection;
        
        // Âç±Èô∫„Å™Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        showDangerousInitModal();
      };
      
      window.cancelDataProtection = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.executeBackupAndInit;
        delete window.executeDangerousInit;
        delete window.cancelDataProtection;
      };
    }
    
    // üí° Á∑äÊÄ•‰øÆÊ≠£: „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ªò„ÅçÂàùÊúüÂåñ„ÅÆÂÆüË°å
    function proceedWithBackupInitialization() {
      showLoading();
      updateStepIndicator('step1');
      google.script.run
        .withSuccessHandler(function(result) {
          // üÜï „É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„ÅÆÂà§ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åæ„Åü„ÅØÊñáÂ≠óÂàóÔºâ
          let message = result;
          let shouldReset = false;
          
          if (typeof result === 'object' && result.message) {
            message = result.message;
            shouldReset = result.resetSidebar || false;
          }
          
          showResult(message);
          updateStepIndicator('step2');
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
          
          // üÜï UXÊîπÂñÑ: ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„É™„Çª„ÉÉ„Éà - ÁÑ°ÂäπÂåñ
          // if (shouldReset) {
          //   setTimeout(function() {
          //     resetSidebarAfterInitialization();
          //   }, 3000); // 3ÁßíÂæå„Å´„É™„Çª„ÉÉ„ÉàÔºà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË¶ã„Åõ„Å¶„Åã„ÇâÔºâ
          // }
        })
        .withFailureHandler(function(error) {
          showResult('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº: ' + error.message, true);
        })
        .createBackupAndNewTable();
    }
    
    // üí° Á∑äÊÄ•‰øÆÊ≠£: Âç±Èô∫„Å™Áõ¥Êé•ÂàùÊúüÂåñ„ÅÆÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
    function showDangerousInitModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.9); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h3 style="margin: 0; color: #d32f2f; font-size: 20px; font-weight: bold;">ÊúÄÁµÇÁ¢∫Ë™çÔºö„Éá„Éº„ÇøÊ∂àÂ§±</h3>
          </div>
          
          <div style="background: #ffebee; border: 2px solid #f44336; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="color: #c62828; font-weight: bold; margin-bottom: 12px;">üö® „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„Åó„ÅßÂàùÊúüÂåñ„ÇíÂÆüË°å„Åó„Åæ„Åô</div>
            <div style="color: #d32f2f; font-size: 14px; line-height: 1.6;">
              <strong>ÂÆåÂÖ®„Å´ÂâäÈô§„Åï„Çå„ÇãÂÜÖÂÆπÔºö</strong><br>
              ‚Ä¢ ÂÖ®„Å¶„ÅÆ„Éó„É≠„É≥„Éó„Éà<br>
              ‚Ä¢ ÁîüÊàêÊ∏à„Åø„ÅÆÂÖ®ÁîªÂÉè<br>
              ‚Ä¢ „É©„Ç§„Éñ„É©„É™„ÅÆ„Éá„Éº„Çø<br>
              ‚Ä¢ „Åù„ÅÆ‰ªñ„ÅÆÂÖ®„Éá„Éº„Çø<br><br>
              <strong style="color: #b71c1c;">‚ùå „Åì„ÅÆÊìç‰Ωú„ÅØÂÆåÂÖ®„Å´Âèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì</strong>
            </div>
          </div>
          
          <div style="text-align: center; color: #424242; font-size: 14px; margin-bottom: 24px;">
            Êú¨ÂΩì„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„Åó„ÅßÂàùÊúüÂåñ„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="cancelDangerousInit()" style="
              flex: 1; padding: 14px; border: 2px solid #4caf50; background: white; 
              color: #388e3c; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#e8f5e8'" onmouseout="this.style.background='white'">
              üíæ Êàª„Å£„Å¶„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            </button>
            <button onclick="confirmDangerousInit()" style="
              flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
              color: white; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(244, 67, 54, 0.4)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(244, 67, 54, 0.3)'">
              üî¥ Âº∑Âà∂ÂÆüË°å
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
      window.cancelDangerousInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelDangerousInit;
        delete window.confirmDangerousInit;
        
        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„Å´Êàª„Çã
        showBackupConfirmationModal();
      };
      
      window.confirmDangerousInit = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelDangerousInit;
        delete window.confirmDangerousInit;
        
        // Âç±Èô∫„Å™Áõ¥Êé•ÂàùÊúüÂåñ„ÇíÂÆüË°å
        proceedWithDirectInitialization();
      };
    }

    // üí° Á∑äÊÄ•‰øÆÊ≠£: Áõ¥Êé•ÂàùÊúüÂåñÔºà„Éá„Éº„Çø„Å™„Åó„ÅÆÂ†¥ÂêàÔºâ
    function proceedWithDirectInitialization() {
      showLoading();
      updateStepIndicator('step1');
      google.script.run
        .withSuccessHandler(function(result) {
          // üÜï „É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„ÅÆÂà§ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åæ„Åü„ÅØÊñáÂ≠óÂàóÔºâ
          let message = result;
          let shouldReset = false;
          
          if (typeof result === 'object' && result.message) {
            message = result.message;
            shouldReset = result.resetSidebar || false;
          }
          
          showResult(message);
          updateStepIndicator('step2');
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
          
          // üÜï UXÊîπÂñÑ: ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„É™„Çª„ÉÉ„Éà - ÁÑ°ÂäπÂåñ
          // if (shouldReset) {
          //   setTimeout(function() {
          //     resetSidebarAfterInitialization();
          //   }, 3000); // 3ÁßíÂæå„Å´„É™„Çª„ÉÉ„ÉàÔºà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË¶ã„Åõ„Å¶„Åã„ÇâÔºâ
          // }
        })
        .withFailureHandler(function(error) {
          showResult('ÂàùÊúüÂåñ„Ç®„É©„Éº: ' + error.message, true);
        })
        .createStructuredTable();
    }

    function generateFromStructuredTable() {
      // „Éú„Çø„É≥„ÅåÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
      const generateBtn = document.getElementById('generateBtn');
      if (generateBtn.disabled) {
        return;
      }

      // üéØ „É¢„Éá„É´ÈÅ∏ÊäûÂÄ§„ÇíÂèñÂæó
      const modelSelector = document.getElementById('modelSelector');
      const selectedModel = modelSelector.value || null;
      
      // üéØ „Çµ„Ç§„Ç∫ÈÅ∏ÊäûÂÄ§„ÇíÂèñÂæó
      const sizeSelector = document.getElementById('sizeSelector');
      const forcedSize = sizeSelector.value || null;
      
      // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞: ÈÅ∏Êäû„Åï„Çå„Åü„É¢„Éá„É´„Å®„Çµ„Ç§„Ç∫„ÇíË°®Á§∫
      console.log(`ü§ñ ÈÅ∏Êäû„É¢„Éá„É´: ${selectedModel || 'dall-e-3 („Éá„Éï„Ç©„É´„Éà)'}`);
      if (forcedSize) {
        console.log(`üîß Âº∑Âà∂„Çµ„Ç§„Ç∫ÊåáÂÆö: ${forcedSize}`);
        showProcessingMessage(`üé® ÁîªÂÉèÁîüÊàêÈñãÂßã‰∏≠... („É¢„Éá„É´: ${selectedModel || 'DALL-E 3'}, „Çµ„Ç§„Ç∫: ${forcedSize})`);
      } else {
        console.log('ü§ñ Ëá™Âãï„Çµ„Ç§„Ç∫Âà§ÂÆö„É¢„Éº„Éâ');
        showProcessingMessage(`üé® ÁîªÂÉèÁîüÊàê„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô... („É¢„Éá„É´: ${selectedModel || 'DALL-E 3'}, Ëá™Âãï„Çµ„Ç§„Ç∫Âà§ÂÆö)`);
      }

      showLoading();
      updateStepIndicator('step3');
      startImageGenerationProgress();
      
      google.script.run
        .withSuccessHandler(function(result) {
          updateProgress(100, '‚úÖ ÁîªÂÉèÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ', 'ÂÆå‰∫Ü');
          // setTimeoutÁÑ°ÂäπÂåñ - Áõ¥Êé•ÂÆüË°å
          hideProgressModal();
          hideTopMessage();
          showSuccessMessage('‚úÖ ÁîªÂÉèÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
          showResult(result);
          // ÁîªÂÉèÁîüÊàêÂÆå‰∫ÜÂæå„Å´„Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
        })
        .withFailureHandler(function(error) {
          hideProgressModal();
          hideTopMessage();
          
          // üîß „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Âº∑Âåñ
          let errorMessage = '‚ùå ÁîªÂÉèÁîüÊàê„Ç®„É©„Éº: ';
          if (error && error.message) {
            errorMessage += error.message;
          } else if (typeof error === 'string') {
            errorMessage += error;
          } else {
            errorMessage += '‰∏çÊòé„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
          }
          
          // üéØ ÁâπÂÆö„ÅÆ„Ç®„É©„Éº„Éë„Çø„Éº„É≥„Å´ÂØæ„Åô„ÇãÂØæÂá¶Ê≥ï„ÇíËøΩÂä†
          if (errorMessage.includes('ÁîªË≥™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ')) {
            errorMessage += '\n\nüí° ÂØæÂá¶Ê≥ï: HÂàóÔºàÁîªË≥™Ôºâ„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (errorMessage.includes('6ÂàÜ') || errorMessage.includes('ÂÆüË°åÊôÇÈñì')) {
            errorMessage += '\n\nüí° ÂØæÂá¶Ê≥ï: Â§ßÈáè„ÅÆÁîªÂÉè„ÅØËá™ÂãïÁöÑ„Å´„Éê„ÉÉ„ÉÅÂá¶ÁêÜ„Åï„Çå„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (errorMessage.includes('„É¨„Éº„ÉàÂà∂Èôê')) {
            errorMessage += '\n\nüí° ÂØæÂá¶Ê≥ï: 1ÂàÜÂæå„Å´ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (errorMessage.includes('„Éó„É≠„É≥„Éó„Éà„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì')) {
            errorMessage += '\n\nüí° ÂØæÂá¶Ê≥ï: BÂàó„Å´„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (errorMessage.includes('Invalid value:') && errorMessage.includes('size')) {
            errorMessage += '\n\nüí° ÂØæÂá¶Ê≥ï: ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ\n„Éª1024x1024ÔºàÊ≠£ÊñπÂΩ¢Ôºâ\n„Éª1536x1024ÔºàÊ®™Èï∑Ôºâ\n„Éª1024x1536ÔºàÁ∏¶Èï∑Ôºâ\n„ÅÆ„ÅÑ„Åö„Çå„Åã„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nüîß „Åì„ÅÆÂïèÈ°å„ÅØËá™Âãï‰øÆÊ≠£„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÊõ¥Êñ∞„Åó„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else if (errorMessage.includes('„Éê„ÉÉ„ÉÅ„Ç®„É©„Éº')) {
            errorMessage += '\n\nüí° ÂØæÂá¶Ê≥ï: „Éê„ÉÉ„ÉÅÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁîªÂÉèÊï∞„ÇíÊ∏õ„Çâ„Åó„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          }
          
          showErrorMessage(errorMessage);
          showResult(errorMessage, true);
        })
        .generateImagesFromStructuredTableWithProgress(forcedSize, selectedModel);
    }

    function createTableOnly() {
      showLoading();
      updateStepIndicator('step2');
      google.script.run
        .withSuccessHandler(function(result) {
          // üÜï „É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„ÅÆÂà§ÂÆöÔºà„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åæ„Åü„ÅØÊñáÂ≠óÂàóÔºâ
          let message = result;
          let shouldReset = false;
          
          if (typeof result === 'object' && result.message) {
            message = result.message;
            shouldReset = result.resetSidebar || false;
          }
          
          showResult(message);
          // Ë°®„ÇØ„É™„Ç¢ÂÆå‰∫ÜÂæå„Å´„Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
          
          // üÜï UXÊîπÂñÑ: ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„É™„Çª„ÉÉ„Éà - ÁÑ°ÂäπÂåñ
          // if (shouldReset) {
          //   setTimeout(function() {
          //     resetSidebarAfterInitialization();
          //   }, 3000); // 3ÁßíÂæå„Å´„É™„Çª„ÉÉ„ÉàÔºà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË¶ã„Åõ„Å¶„Åã„ÇâÔºâ
          // }
        })
        .withFailureHandler(function(error) {
          showResult('„Ç®„É©„Éº: ' + error.message, true);
        })
        .createStructuredTable();
    }

    function toggleAllImageSelection() {
      showTopMessage('‚òëÔ∏è ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 2000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .toggleAllImageSelection();
    }

    function showDownloadOptions() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.5); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 12px;">üì•</div>
            <h3 style="margin: 0; color: #1a73e8; font-size: 24px; font-weight: bold;">„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊñπÊ≥ï„ÇíÈÅ∏Êäû</h3>
            <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">„ÅäÂ•Ω„Åø„ÅÆÊñπÊ≥ï„ÅßÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</p>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <button class="btn btn-secondary" onclick="downloadToDrive(); closeModal();" style="width: 100%; padding: 20px; text-align: left; position: relative;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 24px;">üìÅ</span>
                <div>
                  <div style="font-weight: bold; font-size: 16px;">Google Drive„Å´‰øùÂ≠ò</div>
                  <small style="display: block; font-size: 12px; opacity: 0.8; margin-top: 4px;">„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„ÄÅ„É™„É≥„ÇØÂÖ±Êúâ„ÅåÂèØËÉΩ</small>
                </div>
              </div>
            </button>
            
            
            <button class="btn" onclick="downloadZip(); closeModal();" style="width: 100%; padding: 20px; text-align: left; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; position: relative;">
              <div style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 24px;">üì¶</span>
                <div>
                  <div style="font-weight: bold; font-size: 16px;">ZIP„Åß„Åæ„Å®„ÇÅ„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</div>
                  <small style="display: block; font-size: 12px; opacity: 0.9; margin-top: 4px;">ÂÖ®ÁîªÂÉè„Çí1„Å§„ÅÆ„Éï„Ç©„É´„ÉÄ„Å´„Åæ„Å®„ÇÅ„Å¶‰øùÂ≠ò</small>
                </div>
              </div>
            </button>
            
            <div style="border-top: 1px solid #eee; margin: 8px 0; padding-top: 16px;">
              <button class="btn" onclick="closeModal();" style="width: 100%; background: #f5f5f5; color: #666; border: 2px solid #ddd;">
                ‚ùå „Ç≠„É£„É≥„Çª„É´
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      window.closeModal = () => {
        document.body.removeChild(modal);
        delete window.closeModal;
        delete window.downloadToDrive;
        delete window.downloadZip;
      };
      
      window.downloadToDrive = () => {
        showTopMessage('üìÅ Google„Éâ„É©„Ç§„Éñ„Å´‰øùÂ≠ò‰∏≠...', 'processing');
        google.script.run
          .withSuccessHandler(function(result) {
            hideTopMessage();
            showSuccessMessage(result, 5000);
          })
          .withFailureHandler(function(error) {
            hideTopMessage();
            showErrorMessage('„Ç®„É©„Éº: ' + error.message);
          })
          .downloadSelectedImagesToDrive();
      };
      
      
      window.downloadZip = () => {
        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        showProgressModal();
        setProgressTitle('üì¶ ZIP‰ΩúÊàê‰∏≠...');
        startZipCreationProgress();
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideProgressModal();
            if (result.error) {
              showErrorMessage(result.error);
              return;
            }
            
            if (result.success && result.imageFiles) {
              // „É≠„Éº„Ç´„É´ZIP„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÂÆüË°å
              createAndDownloadZip(result.zipFileName, result.imageFiles, result.imageCount);
            } else {
              showErrorMessage('‚ùå ZIP„Éï„Ç°„Ç§„É´„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          })
          .withFailureHandler(function(error) {
            hideProgressModal();
            showErrorMessage('„Ç®„É©„Éº: ' + error.message);
          })
          .downloadSelectedImagesAsZip();
      };
    }
    
    
    
    function showImagePreview() {
      showTopMessage('üëÅÔ∏è ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(previewData) {
          hideTopMessage();
          if (previewData.length === 0) {
            showErrorMessage('‚ùå Ë°®Á§∫„Åô„ÇãÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            return;
          }
          
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9); z-index: 999999; display: flex;
            align-items: center; justify-content: center; overflow: auto;
          `;
          
          const gallery = previewData.map((img, i) => `
            <div style="text-align: center; margin: 16px;">
              <img src="${img.url}" style="max-width: 300px; max-height: 300px; border-radius: 8px;">
              <p style="color: white; margin: 8px 0; font-size: 12px;">${img.prompt.substring(0, 50)}...</p>
            </div>
          `).join('');
          
          modal.innerHTML = `
            <div style="background: white; border-radius: 16px; padding: 24px; max-width: 90vw; max-height: 90vh; overflow: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; color: #1a73e8;">üëÅÔ∏è ÁîªÂÉè„Éó„É¨„Éì„É•„Éº (${previewData.length}Êûö)</h3>
                <button onclick="closePreview()" style="background: #ccc; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">‚úï</button>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                ${gallery}
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          window.closePreview = () => {
            document.body.removeChild(modal);
            delete window.closePreview;
          };
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .getAllImagePreviewData();
    }

    // „É≠„Éº„Ç´„É´ZIP„Éï„Ç°„Ç§„É´‰ΩúÊàê„Å®„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function createAndDownloadZip(zipFileName, imageFiles, imageCount) {
      try {
        showTopMessage('üì¶ ZIP„Éï„Ç°„Ç§„É´‰ΩúÊàê‰∏≠...', 'processing');
        
        console.log('ZIP‰ΩúÊàêÈñãÂßã:', {
          fileName: zipFileName,
          fileCount: imageFiles.length,
          files: imageFiles.map(f => ({ name: f.filename, size: f.data.length }))
        });
        
        // ZIP‰ΩúÊàêÔºàPKZIP‰∫íÊèõÔºâ
        const zipData = createZipData(imageFiles);
        const blob = new Blob([zipData], { type: 'application/zip' });
        
        console.log('ZIP‰ΩúÊàêÂÆå‰∫Ü:', {
          zipSize: blob.size,
          zipDataLength: zipData.length
        });
        
        // File System Access API„Çí‰ΩøÁî®„Åó„Å¶„Éï„Ç°„Ç§„É´‰øùÂ≠ò„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
        if (window.showSaveFilePicker) {
          // „É¢„ÉÄ„É≥„Éñ„É©„Ç¶„Ç∂„ÅÆÂ†¥Âêà
          saveFileWithPicker(blob, zipFileName, imageCount);
        } else {
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöËá™Âãï„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          downloadBlob(blob, zipFileName);
          showSuccessMessage(`‚úÖ ZIP„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫ÜÔºÅ\n${imageCount}Êûö„ÅÆÁîªÂÉè„Çí‰øùÂ≠ò`, 4000);
        }
      } catch (error) {
        console.error('ZIP‰ΩúÊàê„Ç®„É©„Éº:', error);
        showErrorMessage('‚ùå ZIP„Éï„Ç°„Ç§„É´‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }

    // File System Access API„Çí‰ΩøÁî®„Åó„Åü„Éï„Ç°„Ç§„É´‰øùÂ≠ò
    async function saveFileWithPicker(blob, filename, imageCount) {
      try {
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{
            description: 'ZIP„Ç¢„Éº„Ç´„Ç§„Éñ',
            accept: { 'application/zip': ['.zip'] }
          }]
        });
        
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        
        showSuccessMessage(`‚úÖ ZIP„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫ÜÔºÅ\n${imageCount}Êûö„ÅÆÁîªÂÉè„Çí‰øùÂ≠ò\nüìÅ ‰øùÂ≠òÂÖà: ${filename}`, 5000);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('„Éï„Ç°„Ç§„É´‰øùÂ≠ò„Ç®„É©„Éº:', error);
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
          downloadBlob(blob, filename);
          showSuccessMessage(`‚úÖ ZIP„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫ÜÔºÅ\n${imageCount}Êûö„ÅÆÁîªÂÉè„Çí‰øùÂ≠ò`, 4000);
        }
      }
    }

    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂæìÊù•„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊñπÂºè
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ZIP‰ΩúÊàêÔºàWindows‰∫íÊèõÂΩ¢ÂºèÔºâ
    function createZipData(imageFiles) {
      const files = [];
      let offset = 0;
      
      // ÁèæÂú®„ÅÆÊó•ÊôÇ„ÇíDOSÂΩ¢Âºè„Å´Â§âÊèõ
      const now = new Date();
      const dosTime = ((now.getHours() << 11) | (now.getMinutes() << 5) | (now.getSeconds() >> 1));
      const dosDate = (((now.getFullYear() - 1980) << 9) | ((now.getMonth() + 1) << 5) | now.getDate());
      
      // ÂêÑ„Éï„Ç°„Ç§„É´„ÅÆ„É≠„Éº„Ç´„É´„Éò„ÉÉ„ÉÄ„Å®„Éá„Éº„Çø„Çí‰ΩúÊàê
      for (const file of imageFiles) {
        const filenameBytes = new TextEncoder().encode(file.filename);
        const fileData = base64ToUint8Array(file.data);
        const crc32 = calculateCRC32(fileData);
        
        // „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„Éò„ÉÉ„ÉÄÔºà30„Éê„Ç§„Éà + „Éï„Ç°„Ç§„É´ÂêçÔºâ
        const localHeader = new Uint8Array(30 + filenameBytes.length);
        const view = new DataView(localHeader.buffer);
        
        // „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„Éò„ÉÉ„ÉÄ„Ç∑„Ç∞„Éç„ÉÅ„É£
        view.setUint32(0, 0x04034b50, true);
        // Â±ïÈñã„Å´ÂøÖË¶Å„Å™„Éê„Éº„Ç∏„Éß„É≥Ôºà2.0Ôºâ
        view.setUint16(4, 20, true);
        // Ê±éÁî®„Éì„ÉÉ„Éà„Éï„É©„Ç∞
        view.setUint16(6, 0, true);
        // ÂúßÁ∏ÆÊñπÂºèÔºà0 = ÁÑ°ÂúßÁ∏ÆÔºâ
        view.setUint16(8, 0, true);
        // ÊúÄÁµÇÊõ¥Êñ∞ÊôÇÂàªÔºàDOSÂΩ¢ÂºèÔºâ
        view.setUint16(10, dosTime, true);
        // ÊúÄÁµÇÊõ¥Êñ∞Êó•‰ªòÔºàDOSÂΩ¢ÂºèÔºâ
        view.setUint16(12, dosDate, true);
        // CRC-32
        view.setUint32(14, crc32, true);
        // ÂúßÁ∏Æ„Çµ„Ç§„Ç∫
        view.setUint32(18, fileData.length, true);
        // ÈùûÂúßÁ∏Æ„Çµ„Ç§„Ç∫
        view.setUint32(22, fileData.length, true);
        // „Éï„Ç°„Ç§„É´Âêç„ÅÆÈï∑„Åï
        view.setUint16(26, filenameBytes.length, true);
        // Êã°Âºµ„Éï„Ç£„Éº„É´„Éâ„ÅÆÈï∑„Åï
        view.setUint16(28, 0, true);
        
        // „Éï„Ç°„Ç§„É´Âêç„Çí„Ç≥„Éî„Éº
        localHeader.set(filenameBytes, 30);
        
        files.push({
          localHeader: localHeader,
          data: fileData,
          filename: filenameBytes,
          crc32: crc32,
          offset: offset,
          dosTime: dosTime,
          dosDate: dosDate
        });
        
        offset += localHeader.length + fileData.length;
      }
      
      const centralDirStart = offset;
      
      // „Çª„É≥„Éà„É©„É´„Éá„Ç£„É¨„ÇØ„Éà„É™„É¨„Ç≥„Éº„Éâ„Çí‰ΩúÊàê
      const centralDirRecords = [];
      for (const file of files) {
        const centralDirRecord = new Uint8Array(46 + file.filename.length);
        const view = new DataView(centralDirRecord.buffer);
        
        // „Çª„É≥„Éà„É©„É´„Éá„Ç£„É¨„ÇØ„Éà„É™„Éï„Ç°„Ç§„É´„Éò„ÉÉ„ÉÄ„Ç∑„Ç∞„Éç„ÉÅ„É£
        view.setUint32(0, 0x02014b50, true);
        // ‰ΩúÊàê„Åó„Åü„Éê„Éº„Ç∏„Éß„É≥ÔºàMS-DOSÔºâ
        view.setUint16(4, 0x0014, true);  // 2.0, MS-DOS
        // Â±ïÈñã„Å´ÂøÖË¶Å„Å™„Éê„Éº„Ç∏„Éß„É≥
        view.setUint16(6, 20, true);
        // Ê±éÁî®„Éì„ÉÉ„Éà„Éï„É©„Ç∞
        view.setUint16(8, 0, true);
        // ÂúßÁ∏ÆÊñπÂºè
        view.setUint16(10, 0, true);
        // ÊúÄÁµÇÊõ¥Êñ∞ÊôÇÂàª
        view.setUint16(12, file.dosTime, true);
        // ÊúÄÁµÇÊõ¥Êñ∞Êó•‰ªò
        view.setUint16(14, file.dosDate, true);
        // CRC-32
        view.setUint32(16, file.crc32, true);
        // ÂúßÁ∏Æ„Çµ„Ç§„Ç∫
        view.setUint32(20, file.data.length, true);
        // ÈùûÂúßÁ∏Æ„Çµ„Ç§„Ç∫
        view.setUint32(24, file.data.length, true);
        // „Éï„Ç°„Ç§„É´Âêç„ÅÆÈï∑„Åï
        view.setUint16(28, file.filename.length, true);
        // Êã°Âºµ„Éï„Ç£„Éº„É´„Éâ„ÅÆÈï∑„Åï
        view.setUint16(30, 0, true);
        // „Éï„Ç°„Ç§„É´„Ç≥„É°„É≥„Éà„ÅÆÈï∑„Åï
        view.setUint16(32, 0, true);
        // „Éá„Ç£„Çπ„ÇØÁï™Âè∑ÈñãÂßã
        view.setUint16(34, 0, true);
        // ÂÜÖÈÉ®„Éï„Ç°„Ç§„É´Â±ûÊÄßÔºà„Éê„Ç§„Éä„É™„Éï„Ç°„Ç§„É´Ôºâ
        view.setUint16(36, 0, true);
        // Â§ñÈÉ®„Éï„Ç°„Ç§„É´Â±ûÊÄßÔºàMS-DOS‰∫íÊèõÔºâ
        view.setUint32(38, 0, true);  // ÈÄöÂ∏∏„Éï„Ç°„Ç§„É´
        // „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„Éò„ÉÉ„ÉÄ„ÅÆÁõ∏ÂØæ„Ç™„Éï„Çª„ÉÉ„Éà
        view.setUint32(42, file.offset, true);
        
        // „Éï„Ç°„Ç§„É´Âêç„Çí„Ç≥„Éî„Éº
        centralDirRecord.set(file.filename, 46);
        
        centralDirRecords.push(centralDirRecord);
        offset += centralDirRecord.length;
      }
      
      const centralDirSize = offset - centralDirStart;
      
      // End of Central Directory Record
      const endRecord = new Uint8Array(22);
      const endView = new DataView(endRecord.buffer);
      
      // End of Central Directory „Ç∑„Ç∞„Éç„ÉÅ„É£
      endView.setUint32(0, 0x06054b50, true);
      // „Åì„ÅÆ„Éá„Ç£„Çπ„ÇØ„ÅÆÁï™Âè∑
      endView.setUint16(4, 0, true);
      // Central Directory„ÅåÈñãÂßã„Åô„Çã„Éá„Ç£„Çπ„ÇØ„ÅÆÁï™Âè∑
      endView.setUint16(6, 0, true);
      // „Åì„ÅÆ„Éá„Ç£„Çπ„ÇØ„ÅÆCentral Directory„É¨„Ç≥„Éº„ÉâÊï∞
      endView.setUint16(8, files.length, true);
      // Central Directory„É¨„Ç≥„Éº„Éâ„ÅÆÁ∑èÊï∞
      endView.setUint16(10, files.length, true);
      // Central Directory„ÅÆ„Çµ„Ç§„Ç∫
      endView.setUint32(12, centralDirSize, true);
      // Central Directory„ÅÆÈñãÂßã„Ç™„Éï„Çª„ÉÉ„Éà
      endView.setUint32(16, centralDirStart, true);
      // ZIP„Éï„Ç°„Ç§„É´„Ç≥„É°„É≥„Éà„ÅÆÈï∑„Åï
      endView.setUint16(20, 0, true);
      
      // ÂÖ®‰Ωì„ÇíÁµêÂêà
      const totalSize = offset + 22;
      const zipData = new Uint8Array(totalSize);
      let pos = 0;
      
      // „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„Éò„ÉÉ„ÉÄ„Å®„Éá„Éº„Çø„ÇíËøΩÂä†
      for (const file of files) {
        zipData.set(file.localHeader, pos);
        pos += file.localHeader.length;
        zipData.set(file.data, pos);
        pos += file.data.length;
      }
      
      // „Çª„É≥„Éà„É©„É´„Éá„Ç£„É¨„ÇØ„Éà„É™„É¨„Ç≥„Éº„Éâ„ÇíËøΩÂä†
      for (const record of centralDirRecords) {
        zipData.set(record, pos);
        pos += record.length;
      }
      
      // End of Central Directory Record„ÇíËøΩÂä†
      zipData.set(endRecord, pos);
      
      return zipData;
    }

    // Base64„ÇíUint8Array„Å´Â§âÊèõ
    function base64ToUint8Array(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    // CRC32Ë®àÁÆó
    function calculateCRC32(data) {
      const crcTable = new Uint32Array(256);
      for (let i = 0; i < 256; i++) {
        let c = i;
        for (let j = 0; j < 8; j++) {
          c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
        }
        crcTable[i] = c;
      }
      
      let crc = 0xFFFFFFFF;
      for (let i = 0; i < data.length; i++) {
        crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
      }
      return crc ^ 0xFFFFFFFF;
    }

    function regenerateSelectedImages() {
      showTopMessage('üîÑ ÈÅ∏ÊäûÁîªÂÉè„ÅÆÂÜçÁîüÊàê„ÇíÈñãÂßã...', 'processing');
      
      // ÈÅ∏ÊäûÁîªÂÉèÂÜçÁîüÊàêÂ∞ÇÁî®„ÅÆÈÄ≤Êçó
      showProgressModal();
      setProgressTitle('üîÑ ÈÅ∏ÊäûÁîªÂÉè„ÇíÂÜçÁîüÊàê‰∏≠...');
      
      // „Åæ„ÅöÈÅ∏Êäû„Åï„Çå„ÅüÁîªÂÉèÊûöÊï∞„ÇíÂèñÂæó
      google.script.run
        .withSuccessHandler(function(selectedCount) {
          if (selectedCount > 0) {
            startProgressWithImageCount(selectedCount);
          } else {
            hideProgressModal();
            hideTopMessage();
            showErrorMessage('ÈÅ∏Êäû„Åï„Çå„ÅüÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            return;
          }
        })
        .withFailureHandler(function(error) {
          hideProgressModal();
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
          return;
        })
        .getSelectedImageCount();
      
      google.script.run
        .withSuccessHandler(function(result) {
          completeImageGeneration();
          hideTopMessage();
          showSuccessMessage(result);
        })
        .withFailureHandler(function(error) {
          hideProgressModal();
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .regenerateSelectedImagesWithProgress();
    }

    function deleteSelectedRows() {
      showTopMessage('üóëÔ∏è ÈÅ∏ÊäûË°å„ÇíÂâäÈô§‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result);
          // ÂâäÈô§ÂÆå‰∫ÜÂæå„Å´„Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .deleteSelectedRows();
    }

    function deleteAllImagesWithConfirmation() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          showResult(result);
          // ÂâäÈô§ÂÆå‰∫ÜÂæå„Å´„Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
        })
        .withFailureHandler(function(error) {
          showResult('„Ç®„É©„Éº: ' + error.message, true);
        })
        .deleteAllImagesWithConfirmation();
    }

    function createBackup() {
      showTopMessage('üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result);
          // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫ÜÂæå„Å´„Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
          // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .createBackupAndNewTable();
    }

    // üî• „É©„Ç§„Éñ„É©„É™ÁÆ°ÁêÜÊ©üËÉΩ„ÅÆÊîπÂñÑÔºöÂÖ•Âäõ„Ç∑„Éº„Éà„Åß„ÅÆÊ∑∑‰π±„ÇíËß£Ê±∫
    function toggleAllLibrarySelection() {
      // „Åæ„ÅöÁèæÂú®„ÅÆ„Ç∑„Éº„Éà„Åå„É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      google.script.run
        .withSuccessHandler(function(isLibrarySheet) {
          if (!isLibrarySheet) {
            // ÂÖ•Âäõ„Ç∑„Éº„Éà„ÅÆÂ†¥ÂêàÔºö„É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãï„Åó„Å¶„Åã„ÇâÂÆüË°å
            showResult('üìö „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãï„Åó„Å¶Êìç‰Ωú„ÇíÂÆüË°å„Åó„Åæ„Åô...', false);
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('„Ç®„É©„Éº: ' + error.message, true);
              })
              .switchToLibraryAndToggleSelection();
          } else {
            // „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„ÅÆÂ†¥ÂêàÔºöÁõ¥Êé•ÂÆüË°å
            showLoading();
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('„Ç®„É©„Éº: ' + error.message, true);
              })
              .toggleAllLibrarySelection();
          }
        })
        .withFailureHandler(function(error) {
          showResult('„Ç®„É©„Éº: ' + error.message, true);
        })
        .isCurrentSheetLibrary();
    }

    function downloadSelectedLibraryImages() {
      // „Åæ„ÅöÁèæÂú®„ÅÆ„Ç∑„Éº„Éà„Åå„É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      google.script.run
        .withSuccessHandler(function(isLibrarySheet) {
          if (!isLibrarySheet) {
            // ÂÖ•Âäõ„Ç∑„Éº„Éà„ÅÆÂ†¥ÂêàÔºö„É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãï„Åó„Å¶„Åã„ÇâÂÆüË°å
            showResult('üìö „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãï„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÂÆüË°å„Åó„Åæ„Åô...', false);
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('„Ç®„É©„Éº: ' + error.message, true);
              })
              .switchToLibraryAndDownload();
          } else {
            // „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„ÅÆÂ†¥ÂêàÔºöÁõ¥Êé•ÂÆüË°å
            showLoading();
            google.script.run
              .withSuccessHandler(function(result) {
                showResult(result);
              })
              .withFailureHandler(function(error) {
                showResult('„Ç®„É©„Éº: ' + error.message, true);
              })
              .downloadSelectedLibraryImages();
          }
        })
        .withFailureHandler(function(error) {
          showResult('„Ç®„É©„Éº: ' + error.message, true);
        })
        .isCurrentSheetLibrary();
    }

    // üî• „É©„Ç§„Éñ„É©„É™„É™„Çª„ÉÉ„ÉàÊ©üËÉΩÔºàÂÖ•Âäõ„Ç∑„Éº„ÉàÂØæÂøúÊîπÂñÑÔºâ
    function resetLibraryWithConfirmation() {
      // „Åæ„ÅöÁèæÂú®„ÅÆ„Ç∑„Éº„Éà„Åå„É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      google.script.run
        .withSuccessHandler(function(isLibrarySheet) {
          if (!isLibrarySheet) {
            // ÂÖ•Âäõ„Ç∑„Éº„Éà„ÅÆÂ†¥ÂêàÔºö„É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãï„Åó„Å¶„Åã„ÇâÂÆüË°å
            showResult('üìö „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãï„Åó„Å¶„É™„Çª„ÉÉ„ÉàÊìç‰Ωú„ÇíÂÆüË°å„Åó„Åæ„Åô...', false);
            google.script.run
              .withSuccessHandler(function() {
                // „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„Å´ÁßªÂãïÂæå„ÄÅÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                showLibraryResetModal();
              })
              .withFailureHandler(function(error) {
                showResult('„Ç®„É©„Éº: ' + error.message, true);
              })
              .switchToLibrarySheet();
          } else {
            // „É©„Ç§„Éñ„É©„É™„Ç∑„Éº„Éà„ÅÆÂ†¥ÂêàÔºöÁõ¥Êé•Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            showLibraryResetModal();
          }
        })
        .withFailureHandler(function(error) {
          showResult('„Ç®„É©„Éº: ' + error.message, true);
        })
        .isCurrentSheetLibrary();
    }
    
    // üí° ÊîπÂñÑË¶ÅÊ±Ç: „É©„Ç§„Éñ„É©„É™„É™„Çª„ÉÉ„Éà„ÅÆÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´ÂÆüË£Ö
    function showLibraryResetModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.7); z-index: 999999; display: flex;
        align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìö</div>
            <h3 style="margin: 0; color: #d32f2f; font-size: 20px; font-weight: bold;">„É©„Ç§„Éñ„É©„É™„É™„Çª„ÉÉ„Éà„ÅÆÁ¢∫Ë™ç</h3>
          </div>
          
          <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="color: #ef6c00; font-weight: bold; margin-bottom: 12px;">üö® „É©„Ç§„Éñ„É©„É™„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„Å®„ÄÅÂÖ®„Å¶„ÅÆÁîüÊàêÂ±•Ê≠¥„ÅåÂ§±„Çè„Çå„Åæ„ÅôÔºÅ</div>
            <div style="color: #e65100; font-size: 14px; line-height: 1.6;">
              <strong>ÂâäÈô§„Åï„Çå„ÇãÂÜÖÂÆπÔºö</strong><br>
              ‚Ä¢ ÈÅéÂéª„ÅÆÂÖ®„Å¶„ÅÆÁîªÂÉèÁîüÊàêË®òÈå≤<br>
              ‚Ä¢ „Éó„É≠„É≥„Éó„ÉàÂ±•Ê≠¥<br>
              ‚Ä¢ ÁîüÊàêÊó•ÊôÇÊÉÖÂ†±<br>
              ‚Ä¢ „Åù„ÅÆ‰ªñ„ÅÆÂÖ®„Å¶„ÅÆ„É©„Ç§„Éñ„É©„É™„Éá„Éº„Çø<br><br>
              <strong style="color: #d32f2f;">‚ö†Ô∏è „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì</strong><br>
              <strong style="color: #2e7d32;">‚úÖ Êñ∞„Åó„ÅÑÁ©∫ÁôΩ„ÅÆ„É©„Ç§„Éñ„É©„É™„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åô</strong>
            </div>
          </div>
          
          <div style="text-align: center; color: #424242; font-size: 14px; margin-bottom: 24px;">
            Êú¨ÂΩì„Å´„É©„Ç§„Éñ„É©„É™„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="cancelLibraryReset()" style="
              flex: 1; padding: 14px; border: 2px solid #ccc; background: white; 
              color: #666; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s;
            " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
              ‚ùå „Ç≠„É£„É≥„Çª„É´
            </button>
            <button onclick="confirmLibraryReset()" style="
              flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
              color: white; border-radius: 8px; cursor: pointer; font-weight: bold;
              transition: all 0.2s; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(244, 67, 54, 0.4)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(244, 67, 54, 0.3)'">
              üóëÔ∏è „É™„Çª„ÉÉ„ÉàÂÆüË°å
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden'; // „Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢
      
      // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
      window.cancelLibraryReset = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelLibraryReset;
        delete window.confirmLibraryReset;
      };
      
      window.confirmLibraryReset = () => {
        document.body.removeChild(modal);
        document.body.style.overflow = 'auto';
        delete window.cancelLibraryReset;
        delete window.confirmLibraryReset;
        
        // ÂÆüÈöõ„ÅÆ„É™„Çª„ÉÉ„ÉàÂá¶ÁêÜ„ÇíÂÆüË°å
        proceedWithLibraryReset();
      };
    }
    
    // üí° ÊîπÂñÑË¶ÅÊ±Ç: Á¢∫Ë™çÂæå„ÅÆÂÆüÈöõ„ÅÆ„É©„Ç§„Éñ„É©„É™„É™„Çª„ÉÉ„ÉàÂá¶ÁêÜ
    function proceedWithLibraryReset() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          showResult(result);
        })
        .withFailureHandler(function(error) {
          showResult('„Ç®„É©„Éº: ' + error.message, true);
        })
        .resetImageLibrary();
    }
    
    // üîÑ ÁµêÂêà„Éó„É≠„É≥„Éó„Éà‰∏ÄÊã¨Êõ¥Êñ∞Ê©üËÉΩ
    function updateAllCombinedPrompts() {
      showTopMessage('üîÑ ÁµêÂêà„Éó„É≠„É≥„Éó„Éà„Çí‰∏ÄÊã¨Êõ¥Êñ∞‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 4000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .updateAllCombinedPrompts();
    }

    // üÜï UXÊîπÂñÑ: ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆ„Çµ„Ç§„Éâ„Éê„Éº„É™„Çª„ÉÉ„Éà
    function resetSidebarAfterInitialization() {
      try {
        console.log('üîÑ ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆUX„É™„Çª„ÉÉ„Éà„ÇíÈñãÂßã');
        
        // 1. „Çµ„Ç§„Éâ„Éê„Éº„Çí„Éà„ÉÉ„ÉóË°®Á§∫„Å´Êàª„Åô
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        const container = document.querySelector('.container');
        if (container) {
          container.scrollTop = 0;
        }
        
        // 2. „Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
        updateStepIndicator('step1');
        
        // 3. „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
        hideLoading();
        hideProgressModal();
        
        // 4. „Éà„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        showTopMessage('‚úÖ ÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„Éó„É≠„É≥„Éó„ÉàÂÖ•Âäõ„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô', 'success', 4000);
        
        // 5. Êñ∞„Åó„ÅÑ„Ç∑„Éº„Éà„ÅÆÁä∂ÊÖã„Å´Âêà„Çè„Åõ„Å¶„Éú„Çø„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞ - ÁÑ°ÂäπÂåñ
        // setTimeout(function() {
        //   // checkSheetState(); // ÂÆåÂÖ®ÁÑ°ÂäπÂåñ - Âãï‰ΩúËªΩÈáèÂåñ
        //   console.log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆUX„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü');
        // }, 500);
        console.log('‚úÖ ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆUX„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü');
        
        // 6. ÂÖ•Âäõ„Ç∑„Éº„Éà„ÅåÂ∑¶Á´Ø„Å´ÁßªÂãï„Åó„Åü„Åì„Å®„Çí„É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü• - ÁÑ°ÂäπÂåñ
        // setTimeout(function() {
        //   showTopMessage('üìã ÂÖ•Âäõ„Ç∑„Éº„Éà„ÅåÂ∑¶Á´Ø„Å´ÈÖçÁΩÆ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØÂè≥Á´Ø„Å´„ÅÇ„Çä„Åæ„Åô', 'info', 3000);
        // }, 5000);
        showTopMessage('üìã ÂÖ•Âäõ„Ç∑„Éº„Éà„ÅåÂ∑¶Á´Ø„Å´ÈÖçÁΩÆ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØÂè≥Á´Ø„Å´„ÅÇ„Çä„Åæ„Åô', 'info', 3000);
        
      } catch (error) {
        console.error('UX„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
      }
    }

    // ‚úÖ ÂÖ®ÈÅ∏ÊäûÂ∞ÇÁî®Ê©üËÉΩ
    function selectAllImagesUI() {
      showTopMessage('‚òëÔ∏è ÂÖ®ÈÅ∏Êäû‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .selectAllImages();
    }

    // ‚ùå ÂÖ®ÈÅ∏ÊäûËß£Èô§Â∞ÇÁî®Ê©üËÉΩ
    function clearAllImageSelectionUI() {
      showTopMessage('‚ùå ÂÖ®ÈÅ∏ÊäûËß£Èô§‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .clearAllImageSelection();
    }

    // ‚úÖ „É©„Ç§„Éñ„É©„É™ÂÖ®ÈÅ∏ÊäûÂ∞ÇÁî®Ê©üËÉΩ
    function selectAllLibraryImagesUI() {
      showTopMessage('‚òëÔ∏è „É©„Ç§„Éñ„É©„É™ÂÖ®ÈÅ∏Êäû‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .selectAllLibraryImages();
    }

    // ‚ùå „É©„Ç§„Éñ„É©„É™ÂÖ®ÈÅ∏ÊäûËß£Èô§Â∞ÇÁî®Ê©üËÉΩ
    function clearAllLibrarySelectionUI() {
      showTopMessage('‚ùå „É©„Ç§„Éñ„É©„É™ÂÖ®ÈÅ∏ÊäûËß£Èô§‰∏≠...', 'processing');
      google.script.run
        .withSuccessHandler(function(result) {
          hideTopMessage();
          showSuccessMessage(result, 3000);
        })
        .withFailureHandler(function(error) {
          hideTopMessage();
          showErrorMessage('„Ç®„É©„Éº: ' + error.message);
        })
        .clearAllLibrarySelection();
    }

    // üîç „É©„Ç§„Éñ„É©„É™Ë®∫Êñ≠Ê©üËÉΩ
    function diagnoseLibraryImages() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          // üöÄ UXÊîπÂñÑÔºöË®∫Êñ≠ÁµêÊûú„ÇÇ‰∏äÈÉ®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Å´Áµ±‰∏Ä
          showTopMessage(result, 'info', 10000);
        })
        .withFailureHandler(function(error) {
          showResult('Ë®∫Êñ≠„Ç®„É©„Éº: ' + error.message, true);
        })
        .diagnoseLibraryImageIssues();
    }

    // ÔøΩÔøΩ ÂÖ®„Éú„Çø„É≥„ÇíÂº∑Âà∂ÊúâÂäπÂåñÔºàËªΩÈáèÂåñ„É¢„Éº„ÉâÔºâ
    function forceEnableAllButtons() {
      console.log('üî• ÂÖ®„Éú„Çø„É≥„ÇíÂº∑Âà∂ÊúâÂäπÂåñÔºàËªΩÈáèÂåñ„É¢„Éº„ÉâÔºâ');
      
      // ÂÖ®„Éú„Çø„É≥„ÇíÂº∑Âà∂ÁöÑ„Å´ÊúâÂäπÂåñ
      const buttons = ['setupBtn', 'generateBtn', 'backupBtn', 'restoreBtn'];
      buttons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('disabled');
          btn.title = '';
        }
      });
      
      // ÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
      const managementSection = document.getElementById('managementSection');
      if (managementSection) {
        managementSection.style.display = 'block';
      }
    }
  </script>
</body>
</html> 